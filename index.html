<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisara Jahit - Smart POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        'primary-dark': '#1E3A8A',
                        'primary-light': '#3B82F6',
                        secondary: '#60A5FA',
                        accent: '#93C5FD',
                        whatsapp: '#25D366',
                        success: '#059669',
                        warning: '#D97706',
                        danger: '#DC2626'
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out'
                    }
                }
            }
        }

        tailwind.config.theme.extend.keyframes = {
            slideIn: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(0)' }
            },
            fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary to-primary-dark">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl text-white">üëó</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">KISARA JAHIT</h1>
                <p class="text-gray-600 dark:text-gray-400">Smart POS System</p>
            </div>

            <!-- Google Sign-In -->
            <div class="mb-6">
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" 
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left"
                     data-width="100%">
                </div>
            </div>

            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white dark:bg-gray-800 text-gray-500">atau login manual</span>
                </div>
            </div>

            <!-- Manual Login -->
            <div class="mt-6">
                <form id="manual-login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="password" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all pr-12">
                            <button type="button" onclick="togglePassword('password')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary-dark transition-all font-medium transform hover:scale-105">
                        üîê Login Manual
                    </button>
                </form>
            </div>

            <!-- Demo Account -->
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <p class="text-xs text-blue-800 dark:text-blue-200 text-center">
                    Demo: Username: <strong>admin</strong> | Password: <strong>admin123</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Mobile Hamburger Menu Overlay -->
        <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

        <!-- Sidebar Menu -->
        <div id="sidebar" class="fixed left-0 top-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full transition-transform duration-300 z-50">
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Menu</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400" id="sidebar-user">üëë Administrator</p>
                </div>
                <button onclick="closeSidebar()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <nav class="p-4 space-y-2">
                <button onclick="showSection('dashboard')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">üìä</span>
                    Dashboard
                </button>
                <button onclick="showSection('katalog')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">üõçÔ∏è</span>
                    Katalog Produk
                </button>
                <button onclick="showSection('pesanan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">üìã</span>
                    Kelola Pesanan
                </button>
                <button onclick="showSection('pembayaran')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">üí≥</span>
                    Pembayaran & Struk
                </button>
                <button onclick="showSection('pelanggan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">üë•</span>
                    Pelanggan
                </button>
                <button onclick="showSection('pesan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">üí¨</span>
                    Template Pesan
                </button>
                <button onclick="showSection('laporan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all owner-only">
                    <span class="mr-3">üìà</span>
                    Laporan & Analisis
                </button>
                <button onclick="showSection('pengaturan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">‚öôÔ∏è</span>
                    Pengaturan
                </button>
                
                <hr class="my-4 border-gray-200 dark:border-gray-700">
                
                <button onclick="connectPrinter()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-secondary hover:text-white transition-all">
                    <span class="mr-3">üñ®Ô∏è</span>
                    <span id="printer-menu-status">Hubungkan Printer</span>
                </button>
                <button onclick="quickSummary()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-secondary hover:text-white transition-all">
                    <span class="mr-3">üìä</span>
                    Ringkasan Cepat
                </button>
                <button onclick="shareToko()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-whatsapp hover:text-white transition-all">
                    <span class="mr-3">üì±</span>
                    Share Toko
                </button>
                
                <hr class="my-4 border-gray-200 dark:border-gray-700">
                
                <button onclick="logout()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-danger hover:text-white transition-all">
                    <span class="mr-3">üö™</span>
                    Logout
                </button>
            </nav>
        </div>

        <!-- Header -->
        <header class="bg-gradient-to-r from-primary to-primary-dark text-white shadow-lg">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button onclick="openSidebar()" class="mr-4 p-2 rounded-lg hover:bg-white/10 transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold">KISARA JAHIT</h1>
                            <p class="text-sm text-blue-200" id="section-title">Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="hidden sm:block text-right">
                            <div class="text-sm" id="header-user">üëë Administrator</div>
                            <div class="text-xs text-blue-200" id="save-status">üíæ AUTO SAVE</div>
                        </div>
                        <div id="user-avatar" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                            <span class="text-sm">üë§</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 pb-20">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-primary to-primary-light text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üì¶</span>
                            <div>
                                <p class="text-sm opacity-90">Produk</p>
                                <p id="total-products" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-secondary to-accent text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üìã</span>
                            <div>
                                <p class="text-sm opacity-90">Pesanan</p>
                                <p id="total-orders" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-success to-green-500 text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üí∞</span>
                            <div>
                                <p class="text-sm opacity-90">Hari Ini</p>
                                <p id="today-profit" class="text-lg font-bold">Rp 0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-warning to-orange-500 text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üíé</span>
                            <div>
                                <p class="text-sm opacity-90">Bulan Ini</p>
                                <p id="monthly-profit" class="text-lg font-bold">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button onclick="showSection('katalog')" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-all border-l-4 border-primary">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">üõçÔ∏è</span>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Kelola Produk</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Tambah & edit produk</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="showSection('pesanan')" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-all border-l-4 border-secondary">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">üìã</span>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Buat Pesanan</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Pesanan baru</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="showSection('pembayaran')" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-all border-l-4 border-success">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">üí≥</span>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Proses Bayar</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Konfirmasi pembayaran</p>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üìà Aktivitas Terbaru</h3>
                    <div id="recent-activity" class="space-y-3">
                        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada aktivitas</p>
                    </div>
                </div>
            </div>

            <!-- Other sections will be similar but simplified -->
            <!-- Katalog Section -->
            <div id="katalog-section" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Add Product Form -->
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 sticky top-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                                <span id="form-title">Tambah Produk Baru</span>
                            </h3>
                            <form id="product-form" class="space-y-4">
                                <input type="hidden" id="edit-product-id">

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Produk *</label>
                                    <input type="text" id="product-name" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Harga Jual *</label>
                                        <input type="number" id="product-price" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Modal *</label>
                                        <input type="number" id="product-cost" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stok *</label>
                                    <input type="number" id="product-stock" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kategori</label>
                                    <select id="product-category" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        <option value="Elektronik">üì± Elektronik</option>
                                        <option value="Fashion">üëï Fashion</option>
                                        <option value="Makanan">üçî Makanan & Minuman</option>
                                        <option value="Kesehatan">üíä Kesehatan & Kecantikan</option>
                                        <option value="Rumah Tangga">üè† Rumah Tangga</option>
                                        <option value="Olahraga">‚öΩ Olahraga</option>
                                        <option value="Lainnya">üì¶ Lainnya</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deskripsi</label>
                                    <textarea id="product-description" rows="3" placeholder="Jelaskan produk Anda..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Link Gambar (opsional)</label>
                                    <input type="url" id="product-image" placeholder="https://contoh.com/gambar.jpg" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <button type="submit" id="product-submit-btn" class="bg-primary text-white py-3 px-4 rounded-md hover:bg-primary-dark transition-colors font-medium">
                                        ‚ûï Tambah Produk
                                    </button>
                                    <button type="button" onclick="cancelEditProduct()" id="cancel-edit-btn" class="hidden bg-gray-500 text-white py-3 px-4 rounded-md hover:bg-gray-600 transition-colors font-medium">
                                        ‚úï Batal
                                    </button>
                                </div>
                            </form>

                            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <button onclick="generateKatalog()" class="w-full bg-whatsapp text-white py-3 px-4 rounded-md hover:bg-whatsapp/90 transition-colors font-medium">
                                    üìã Generate Katalog WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Products List -->
                    <div class="lg:col-span-2">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Daftar Produk</h3>
                                <div class="flex space-x-2">
                                    <select id="filter-category" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Kategori</option>
                                    </select>
                                    <button onclick="clearAllData()" class="px-3 py-1 text-xs bg-danger text-white rounded hover:bg-red-700 owner-only">üóëÔ∏è Reset</button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <input type="text" id="search-products" placeholder="Cari produk..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Products will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pesanan Section -->
            <div id="pesanan-section" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- New Order Form -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Pesanan Baru</h3>
                        <form id="order-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Pelanggan *</label>
                                <input type="text" id="customer-name" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">No. WhatsApp *</label>
                                <input type="tel" id="customer-phone" placeholder="628123456789" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pilih Produk *</label>
                                <select id="order-product" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="">Pilih produk...</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jumlah *</label>
                                    <input type="number" id="order-quantity" min="1" value="1" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Total</label>
                                    <input type="text" id="order-total" readonly class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alamat Pengiriman</label>
                                <textarea id="customer-address" rows="2" placeholder="Alamat lengkap..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                            </div>

                            <button type="submit" class="w-full bg-success text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                                üìù Buat Pesanan
                            </button>
                        </form>
                    </div>

                    <!-- Orders List -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Pesanan Terbaru</h3>
                            <select id="filter-orders" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Dikonfirmasi</option>
                                <option value="paid">Dibayar</option>
                                <option value="shipped">Dikirim</option>
                                <option value="completed">Selesai</option>
                                <option value="cancelled">Dibatalkan</option>
                            </select>
                        </div>

                        <div id="orders-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Orders will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pembayaran Section -->
            <div id="pembayaran-section" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Payment Form -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üí≥ Konfirmasi Pembayaran</h3>
                        <form id="payment-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pilih Pesanan</label>
                                <select id="payment-order" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                    <option value="">Pilih pesanan...</option>
                                </select>
                            </div>

                            <div id="payment-details" class="hidden bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <h4 class="font-medium text-gray-800 dark:text-white mb-3">Detail Pesanan</h4>
                                <div id="payment-order-info" class="space-y-2 text-sm"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Metode</label>
                                    <select id="payment-method" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                        <option value="Transfer Bank">Transfer Bank</option>
                                        <option value="Tunai">Tunai</option>
                                        <option value="E-Wallet">E-Wallet</option>
                                        <option value="QRIS">QRIS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jumlah</label>
                                    <input type="number" id="payment-amount" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Catatan</label>
                                <textarea id="payment-notes" rows="2" placeholder="No. referensi, nama pengirim..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                            </div>

                            <button type="submit" class="w-full bg-success text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                                ‚úÖ Konfirmasi & Print Struk
                            </button>
                        </form>
                    </div>

                    <!-- Printer & Receipt -->
                    <div class="space-y-6">
                        <!-- Printer Status -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üñ®Ô∏è Printer Bluetooth</h3>
                            
                            <div class="p-4 bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-700 dark:to-blue-900/20 rounded-lg mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div id="printer-status-icon" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                        <div>
                                            <p class="font-medium text-gray-800 dark:text-white">Status Printer</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400" id="printer-connection-status">Tidak terhubung</p>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="connectPrinter()" id="connect-printer-btn" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-all">
                                    <span id="connect-btn-text">üîç Hubungkan Printer</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="testPrint()" id="test-print-btn" class="bg-secondary text-white py-2 px-3 rounded-md hover:bg-blue-600 transition-colors text-sm">
                                    üß™ Test Print
                                </button>
                                <button onclick="disconnectPrinter()" id="disconnect-btn" class="hidden bg-danger text-white py-2 px-3 rounded-md hover:bg-red-700 transition-colors text-sm">
                                    üîå Disconnect
                                </button>
                            </div>
                        </div>

                        <!-- Receipt Preview -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üßæ Preview Struk</h3>
                            <div class="bg-white dark:bg-gray-900 p-6 border border-gray-200 dark:border-gray-700 rounded-lg font-mono text-sm max-h-64 overflow-y-auto" id="receipt-preview">
                                <div class="text-center">
                                    <p class="font-bold text-lg">KISARA JAHIT</p>
                                    <p class="text-sm">Kemiling, Bandar Lampung</p>
                                    <p class="text-center my-3">================================</p>
                                    <p class="text-gray-500 dark:text-gray-400">Pilih pesanan untuk preview</p>
                                    <p class="text-center my-3">================================</p>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-3">
                                <button onclick="printReceipt()" id="print-receipt-btn" class="bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-dark transition-colors">
                                    üñ®Ô∏è Print
                                </button>
                                <button onclick="shareReceipt()" id="share-receipt-btn" class="bg-whatsapp text-white py-2 px-4 rounded-md hover:bg-whatsapp/90 transition-colors">
                                    üì± Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pelanggan Section -->
            <div id="pelanggan-section" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Database Pelanggan</h3>
                        <div class="flex space-x-2">
                            <button onclick="broadcastToCustomers()" class="bg-whatsapp text-white px-4 py-2 rounded-md hover:bg-whatsapp/90 transition-colors text-sm">
                                üì¢ Broadcast
                            </button>
                            <button onclick="exportCustomers()" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition-colors text-sm">
                                üìä Export
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <input type="text" id="search-customers" placeholder="Cari pelanggan..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                    </div>

                    <div id="customers-list" class="space-y-3">
                        <!-- Customers will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Pesan Section -->
            <div id="pesan-section" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Template Pesan -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Template Pesan</h3>
                            <button onclick="addNewTemplate()" class="bg-primary text-white px-3 py-2 rounded-md hover:bg-primary-dark text-sm">
                                ‚ûï Tambah
                            </button>
                        </div>

                        <div id="templates-container" class="space-y-4">
                            <!-- Templates will be rendered here -->
                        </div>
                    </div>

                    <!-- Kirim Pesan -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Kirim Pesan WhatsApp</h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor WhatsApp</label>
                                <input type="tel" id="message-phone" placeholder="628123456789" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pesan</label>
                                <textarea id="message-text" rows="8" placeholder="Tulis pesan..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                            </div>

                            <button onclick="sendWhatsAppMessage()" class="w-full bg-whatsapp text-white py-3 px-4 rounded-md hover:bg-whatsapp/90 transition-colors font-medium">
                                üì± Kirim WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Laporan Section -->
            <div id="laporan-section" class="section hidden">
                <div class="space-y-6">
                    <!-- Revenue Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üìä Pendapatan</h3>
                            <canvas id="revenueChart" width="400" height="200"></canvas>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üí∞ Keuntungan</h3>
                            <canvas id="profitChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üìä Ringkasan Finansial</h3>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gradient-to-r from-success to-green-600 text-white p-4 rounded-lg">
                                <div class="text-sm opacity-90">Total Pendapatan</div>
                                <div id="total-revenue" class="text-xl font-bold">Rp 0</div>
                            </div>
                            <div class="bg-gradient-to-r from-primary to-primary-dark text-white p-4 rounded-lg">
                                <div class="text-sm opacity-90">Total Keuntungan</div>
                                <div id="total-profit" class="text-xl font-bold">Rp 0</div>
                            </div>
                            <div class="bg-gradient-to-r from-secondary to-accent text-white p-4 rounded-lg">
                                <div class="text-sm opacity-90">Pendapatan Bulan</div>
                                <div id="monthly-revenue" class="text-xl font-bold">Rp 0</div>
                            </div>
                            <div class="bg-gradient-to-r from-warning to-orange-600 text-white p-4 rounded-lg">
                                <div class="text-sm opacity-90">Profit Bulan</div>
                                <div id="monthly-profit-display" class="text-xl font-bold">Rp 0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pengaturan Section -->
            <div id="pengaturan-section" class="section hidden">
                <div class="space-y-6">
                    <!-- Store Settings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üè™ Pengaturan Toko</h3>
                        <form id="store-settings-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Toko</label>
                                <input type="text" id="store-name-input" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor WhatsApp</label>
                                <input type="tel" id="admin-phone-input" placeholder="628123456789" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Info Bank</label>
                                <input type="text" id="bank-info-input" placeholder="BCA: 1234567890" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alamat Toko</label>
                                <textarea id="store-address-input" rows="2" placeholder="Alamat lengkap toko" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                            <button type="submit" class="bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-dark transition-colors">
                                üíæ Simpan Pengaturan
                            </button>
                        </form>
                    </div>

                    <!-- Account Settings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üë§ Pengaturan Akun</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-white">Login dengan Google</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Sinkron data lintas device</p>
                                </div>
                                <div id="google-account-status" class="text-sm">
                                    <span class="text-gray-500">Tidak terhubung</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-white">Auto Save</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Simpan otomatis setiap perubahan</p>
                                </div>
                                <input type="checkbox" checked disabled class="w-4 h-4 text-primary">
                            </div>

                            <button onclick="exportAllData()" class="w-full bg-secondary text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">
                                üìä Export Semua Data
                            </button>
                            
                            <button onclick="clearAllData()" class="w-full bg-danger text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors owner-only">
                                üóëÔ∏è Reset Semua Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (same as before but with blue theme) -->
    <!-- Catalog Modal -->
    <div id="catalog-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">üìã Katalog WhatsApp</h3>
                <button onclick="hideCatalogModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div>
                <textarea id="generated-catalog" rows="15" readonly class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white font-mono"></textarea>
            </div>
            <div class="flex space-x-3 mt-4">
                <button onclick="copyCatalog()" class="flex-1 bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-dark transition-colors">
                    üìã Copy
                </button>
                <button onclick="shareCatalog()" class="flex-1 bg-whatsapp text-white py-2 px-4 rounded-md hover:bg-whatsapp/90 transition-colors">
                    üì± Share
                </button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">‚úèÔ∏è Edit Template</h3>
                <button onclick="hideTemplateModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="template-form" class="space-y-4">
                <input type="hidden" id="edit-template-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Template *</label>
                    <input type="text" id="template-name" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Isi Pesan *</label>
                    <textarea id="template-content" rows="6" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                    üí° Gunakan variabel: [NAMA], [PRODUK], [TOTAL], [RESI], [EKSPEDISI]
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="hideTemplateModal()" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded">
                        üíæ Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Broadcast Modal -->
    <div id="broadcast-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">üì¢ Broadcast Pesan</h3>
                <button onclick="hideBroadcastModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="broadcast-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pilih Penerima</label>
                    <select id="broadcast-target" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                        <option value="all">Semua Pelanggan</option>
                        <option value="vip">Pelanggan VIP (Top 10)</option>
                        <option value="recent">Pelanggan Aktif (30 hari terakhir)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pesan Broadcast</label>
                    <textarea id="broadcast-message" rows="6" required placeholder="Tulis pesan broadcast..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="include-catalog" class="mr-2">
                    <label class="text-sm text-gray-700 dark:text-gray-300">Sertakan link katalog produk</label>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="hideBroadcastModal()" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-whatsapp text-white hover:bg-whatsapp/90 rounded">
                        üì± Kirim
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // GOOGLE OAUTH & ENHANCED USER SYSTEM
        let currentUser = null;
        let userRole = null;
        let googleUser = null;
        let isGoogleLogin = false;

        // Enhanced users with Google integration
        let users = [
            { 
                id: 1, 
                username: 'admin', 
                password: 'admin123', 
                role: 'owner', 
                name: 'Administrator',
                created: new Date().toISOString() 
            }
        ];

        // Google Sign-In Configuration
        window.handleCredentialResponse = function(response) {
            // Decode the JWT token
            const responsePayload = decodeJwtResponse(response.credential);
            
            googleUser = {
                id: responsePayload.sub,
                email: responsePayload.email,
                name: responsePayload.name,
                picture: responsePayload.picture
            };

            isGoogleLogin = true;
            loginWithGoogle(googleUser);
        };

        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function loginWithGoogle(googleUserData) {
            currentUser = googleUserData.email;
            userRole = 'owner'; // Google users get owner access
            
            // Update UI with Google user info
            document.getElementById('header-user').innerHTML = `üë§ ${googleUserData.name}`;
            document.getElementById('sidebar-user').innerHTML = `üë§ ${googleUserData.name}`;
            
            // Set user avatar
            const avatar = document.getElementById('user-avatar');
            if (googleUserData.picture) {
                avatar.innerHTML = `<img src="${googleUserData.picture}" class="w-10 h-10 rounded-full">`;
            }

            // Update Google account status
            document.getElementById('google-account-status').innerHTML = `
                <span class="text-green-600">‚úÖ ${googleUserData.email}</span>
            `;

            showMainApp();
            showNotification(`‚úÖ Login berhasil dengan Google! Selamat datang ${googleUserData.name}`, 'success');
            
            // Load data from cloud/localStorage based on user
            loadUserData();
        }

        // Manual login form
        document.getElementById('manual-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                isGoogleLogin = false;
                loginUser(user);
            } else {
                showNotification('‚ùå Username atau password salah!', 'error');
            }
        });

        function loginUser(user) {
            currentUser = user.username;
            userRole = user.role;
            document.getElementById('header-user').innerHTML = user.role === 'owner' ? 'üëë ' + user.name : 'üë§ ' + user.name;
            document.getElementById('sidebar-user').innerHTML = user.role === 'owner' ? 'üëë ' + user.name : 'üë§ ' + user.name;
            showMainApp();
            if (userRole === 'kasir') {
                hideOwnerOnlyFeatures();
            }
            showNotification(`‚úÖ Login berhasil sebagai ${user.name}!`, 'success');
            loadUserData();
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            showSection('dashboard');
        }

        function hideOwnerOnlyFeatures() {
            const ownerOnlyElements = document.querySelectorAll('.owner-only');
            ownerOnlyElements.forEach(element => {
                element.classList.add('hidden');
            });
        }

        function logout() {
            if (isGoogleLogin && googleUser) {
                // Sign out from Google
                google.accounts.id.disableAutoSelect();
            }
            
            currentUser = null;
            userRole = null;
            googleUser = null;
            isGoogleLogin = false;
            
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            // Reset Google account status
            document.getElementById('google-account-status').innerHTML = '<span class="text-gray-500">Tidak terhubung</span>';

            // Show all elements again
            const ownerOnlyElements = document.querySelectorAll('.owner-only');
            ownerOnlyElements.forEach(element => {
                element.classList.remove('hidden');
            });

            showNotification('üö™ Berhasil logout!', 'info');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
        }

        // ENHANCED SIDEBAR NAVIGATION
        function openSidebar() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('mobile-menu-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('mobile-menu-overlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Close sidebar when clicking overlay
        document.getElementById('mobile-menu-overlay').addEventListener('click', closeSidebar);

        // Enhanced section navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').classList.remove('hidden');

            // Update section title
            const titles = {
                dashboard: 'Dashboard',
                katalog: 'Katalog Produk',
                pesanan: 'Kelola Pesanan',
                pembayaran: 'Pembayaran & Struk',
                pelanggan: 'Database Pelanggan',
                pesan: 'Template Pesan',
                laporan: 'Laporan & Analisis',
                pengaturan: 'Pengaturan'
            };
            
            document.getElementById('section-title').textContent = titles[sectionName] || sectionName;

            // Update menu item active state
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('bg-primary', 'text-white');
            });

            // Close sidebar on mobile
            closeSidebar();

            // Special handling for specific sections
            if (sectionName === 'laporan') {
                setTimeout(() => {
                    initializeCharts();
                }, 100);
            }

            if (sectionName === 'pembayaran') {
                updatePaymentOrderOptions();
                updateReceiptPreview();
                updatePrinterStatus(settings.printerConnected, settings.printerDevice?.name);
            }

            if (sectionName === 'pengaturan') {
                loadStoreSettings();
            }
        }

        function loadStoreSettings() {
            document.getElementById('store-name-input').value = settings.storeName || '';
            document.getElementById('admin-phone-input').value = settings.adminPhone || '';
            document.getElementById('bank-info-input').value = settings.bankInfo || '';
            document.getElementById('store-address-input').value = settings.storeAddress || '';
        }

        // Enhanced store settings form
        document.getElementById('store-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();

            settings.storeName = document.getElementById('store-name-input').value;
            settings.adminPhone = document.getElementById('admin-phone-input').value;
            settings.bankInfo = document.getElementById('bank-info-input').value;
            settings.storeAddress = document.getElementById('store-address-input').value;

            autoSave();
            showNotification('‚úÖ Pengaturan toko berhasil disimpan!', 'success');
        });

        // PERMANENT STORAGE SYSTEM (same as before but enhanced for Google users)
        let products = [];
        let orders = [];
        let customers = [];
        let messageTemplates = [];
        let payments = [];
        let settings = {
            storeName: 'Kisara Jahit',
            adminPhone: '',
            bankInfo: 'BCA: 1234567890',
            storeAddress: 'Kemiling, Bandar Lampung',
            printerConnected: false,
            printerDevice: null,
            autoStruk: true
        };

        // Charts variables
        let revenueChart = null;
        let profitChart = null;

        // Enhanced Bluetooth Printer Variables
        let bluetoothDevice = null;
        let bluetoothService = null;
        let bluetoothCharacteristic = null;

        // Enhanced LocalStorage Functions with Google integration
        function saveToLocalStorage() {
            try {
                const storageKey = isGoogleLogin && googleUser ? 
                    `tokoData_${googleUser.id}` : 'tokoOnlineData';
                
                const data = {
                    products,
                    orders,
                    customers,
                    messageTemplates,
                    payments,
                    settings,
                    users,
                    userInfo: isGoogleLogin ? googleUser : { username: currentUser, role: userRole },
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem(storageKey, JSON.stringify(data));
                document.getElementById('save-status').textContent = 'üíæ TERSIMPAN';
                document.getElementById('save-status').className = 'text-xs text-green-200';

                setTimeout(() => {
                    document.getElementById('save-status').textContent = 'üíæ AUTO SAVE';
                    document.getElementById('save-status').className = 'text-xs text-blue-200';
                }, 2000);

                console.log('‚úÖ Data berhasil disimpan!');
            } catch (error) {
                console.error('‚ùå Gagal menyimpan:', error);
                showNotification('‚ùå Gagal menyimpan data!', 'error');
            }
        }

        function loadUserData() {
            try {
                const storageKey = isGoogleLogin && googleUser ? 
                    `tokoData_${googleUser.id}` : 'tokoOnlineData';
                
                const savedData = localStorage.getItem(storageKey);
                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.products) products = data.products;
                    if (data.orders) orders = data.orders;
                    if (data.customers) customers = data.customers;
                    if (data.messageTemplates) messageTemplates = data.messageTemplates;
                    if (data.payments) payments = data.payments;
                    if (data.settings) {
                        settings = { ...settings, ...data.settings };
                    }

                    console.log('‚úÖ Data pengguna berhasil dimuat');
                    showNotification('‚úÖ Data berhasil dimuat!', 'success');
                    
                    // Update UI after loading data
                    initializeApp();
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Gagal memuat data:', error);
            }
            
            // If no data found, initialize with sample data
            initSampleData();
            return false;
        }

        function autoSave() {
            saveToLocalStorage();
        }

        // REST OF THE JAVASCRIPT CODE (Product Management, Orders, etc.)
        // [Include all the existing JavaScript functions from the original code but with blue theme colors]
        
        // Enhanced Product Management
        let isEditingProduct = false;
        let editingProductId = null;

        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const productData = {
                name: document.getElementById('product-name').value,
                price: parseInt(document.getElementById('product-price').value),
                cost: parseInt(document.getElementById('product-cost').value),
                stock: parseInt(document.getElementById('product-stock').value),
                category: document.getElementById('product-category').value,
                description: document.getElementById('product-description').value,
                image: document.getElementById('product-image').value
            };

            if (isEditingProduct && editingProductId) {
                const productIndex = products.findIndex(p => p.id === editingProductId);
                if (productIndex !== -1) {
                    products[productIndex] = {
                        ...products[productIndex],
                        ...productData
                    };
                    showNotification('‚úÖ Produk berhasil diperbarui!', 'success');
                    cancelEditProduct();
                }
            } else {
                const product = {
                    id: Date.now(),
                    ...productData,
                    created: new Date().toISOString()
                };
                products.push(product);
                showNotification('‚úÖ Produk berhasil ditambahkan!', 'success');
                this.reset();
            }

            renderProducts();
            updateOrderProductOptions();
            updateFilterCategories();
            updateStats();
            autoSave();
        });

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            isEditingProduct = true;
            editingProductId = id;

            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-cost').value = product.cost || 0;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-image').value = product.image;

            document.getElementById('form-title').textContent = 'Edit Produk';
            document.getElementById('product-submit-btn').textContent = 'üíæ Update Produk';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
        }

        function cancelEditProduct() {
            isEditingProduct = false;
            editingProductId = null;
            document.getElementById('product-form').reset();
            document.getElementById('form-title').textContent = 'Tambah Produk Baru';
            document.getElementById('product-submit-btn').textContent = '‚ûï Tambah Produk';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        function renderProducts() {
            const container = document.getElementById('products-grid');
            const searchTerm = document.getElementById('search-products')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('filter-category')?.value || '';

            let filteredProducts = products.filter(product => {
                const matchSearch = product.name.toLowerCase().includes(searchTerm) || 
                                  product.description.toLowerCase().includes(searchTerm);
                const matchCategory = !categoryFilter || product.category === categoryFilter;
                return matchSearch && matchCategory;
            });

            container.innerHTML = '';

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-6xl mb-4">üì¶</div>
                        <p class="text-gray-500 dark:text-gray-400">Belum ada produk</p>
                    </div>
                `;
                return;
            }

            filteredProducts.forEach(product => {
                const profit = product.price - (product.cost || 0);
                const profitMargin = product.price > 0 ? ((profit / product.price) * 100).toFixed(1) : 0;

                const productCard = document.createElement('div');
                productCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow';

                productCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 dark:text-white">${product.name}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${product.category}</p>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editProduct(${product.id})" class="text-primary hover:text-primary-dark p-1" title="Edit">‚úèÔ∏è</button>
                            <button onclick="removeProduct(${product.id})" class="text-danger hover:text-red-800 p-1" title="Hapus">üóëÔ∏è</button>
                        </div>
                    </div>

                    ${product.image ? `<img src="${product.image}" alt="${product.name}" class="w-full h-32 object-cover rounded-md mb-3">` : ''}

                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${product.description}</p>

                    <div class="space-y-2 mb-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">Harga:</span>
                            <span class="text-sm font-semibold text-primary">Rp ${product.price.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">Modal:</span>
                            <span class="text-sm">Rp ${(product.cost || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">Profit:</span>
                            <span class="text-sm font-semibold text-success">Rp ${profit.toLocaleString()} (${profitMargin}%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">Stok:</span>
                            <span class="text-sm ${product.stock < 5 ? 'text-danger font-semibold' : ''}">${product.stock}</span>
                        </div>
                    </div>

                    <button onclick="shareProduct(${product.id})" class="w-full bg-whatsapp text-white px-3 py-2 rounded text-sm hover:bg-whatsapp/90 transition-colors">
                        üì± Share Produk
                    </button>
                `;

                container.appendChild(productCard);
            });
        }

        function removeProduct(id) {
            showConfirmDialog('Yakin ingin menghapus produk ini?', () => {
                products = products.filter(p => p.id !== id);
                renderProducts();
                updateOrderProductOptions();
                updateFilterCategories();
                updateStats();
                autoSave();
                showNotification('üóëÔ∏è Produk berhasil dihapus!', 'success');
            });
        }

        function shareProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            let message = `üõçÔ∏è *${product.name}*\n\n`;
            message += `üìù ${product.description}\n\n`;
            message += `üí∞ Harga: *Rp ${product.price.toLocaleString()}*\n`;
            message += `üì¶ Stok: ${product.stock}\n\n`;
            message += `üí¨ Minat? Chat langsung ya!`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Order Management
        document.getElementById('order-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const productId = parseInt(document.getElementById('order-product').value);
            const quantity = parseInt(document.getElementById('order-quantity').value);
            const address = document.getElementById('customer-address').value;

            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('‚ùå Produk tidak ditemukan!', 'error');
                return;
            }

            if (quantity > product.stock) {
                showNotification('‚ùå Stok tidak mencukupi!', 'error');
                return;
            }

            const totalRevenue = product.price * quantity;
            const totalCost = (product.cost || 0) * quantity;
            const totalProfit = totalRevenue - totalCost;

            const order = {
                id: Date.now(),
                customerName,
                customerPhone,
                productId,
                productName: product.name,
                quantity,
                price: product.price,
                cost: product.cost || 0,
                total: totalRevenue,
                profit: totalProfit,
                address,
                status: 'pending',
                date: new Date().toISOString()
            };

            product.stock -= quantity;
            orders.unshift(order);
            updateCustomerDatabase(customerName, customerPhone, totalRevenue);

            renderOrders();
            renderCustomers();
            renderProducts();
            updatePaymentOrderOptions();
            updateStats();
            this.reset();
            autoSave();

            showNotification('‚úÖ Pesanan berhasil dibuat!', 'success');
            addRecentActivity(`üìù Pesanan baru dari ${customerName}`);

            setTimeout(() => {
                sendOrderConfirmation(order);
            }, 1000);
        });

        function updateCustomerDatabase(name, phone, orderValue) {
            let customer = customers.find(c => c.phone === phone);

            if (!customer) {
                customer = {
                    id: Date.now(),
                    name,
                    phone,
                    totalOrders: 0,
                    totalSpent: 0,
                    lastOrder: new Date().toISOString()
                };
                customers.push(customer);
            }

            customer.totalOrders++;
            customer.totalSpent += orderValue;
            customer.lastOrder = new Date().toISOString();
            customer.name = name;
        }

        function renderOrders() {
            const container = document.getElementById('orders-list');
            if (!container) return;

            const statusFilter = document.getElementById('filter-orders')?.value || '';
            let filteredOrders = orders;

            if (statusFilter) {
                filteredOrders = orders.filter(order => order.status === statusFilter);
            }

            container.innerHTML = '';

            if (filteredOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada pesanan</p>';
                return;
            }

            filteredOrders.slice(0, 20).forEach(order => {
                const statusColors = {
                    pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                    confirmed: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    paid: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    shipped: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
                    completed: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                    cancelled: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                };

                const orderEl = document.createElement('div');
                orderEl.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';

                orderEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-gray-800 dark:text-white">${order.customerName}</h4>
                        <select onchange="updateOrderStatus(${order.id}, this.value)" class="text-xs px-2 py-1 rounded ${statusColors[order.status]}">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>‚úÖ Dikonfirmasi</option>
                            <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>üí∞ Dibayar</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>üöö Dikirim</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>üéâ Selesai</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>‚ùå Dibatalkan</option>
                        </select>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${order.productName} x ${order.quantity}</p>
                    <div class="flex justify-between text-sm">
                        <span class="text-primary font-semibold">Rp ${order.total.toLocaleString()}</span>
                        <span class="text-success font-semibold">Profit: Rp ${(order.profit || 0).toLocaleString()}</span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">üì± ${order.customerPhone}</p>
                    ${order.address ? `<p class="text-xs text-gray-500 dark:text-gray-400">üìç ${order.address}</p>` : ''}
                    <div class="flex space-x-2 mt-3">
                        <button onclick="contactCustomer('${order.customerPhone}', '${order.customerName}')" class="text-xs bg-whatsapp text-white px-2 py-1 rounded hover:bg-whatsapp/90">üí¨ Chat</button>
                        <button onclick="sendOrderUpdate(${order.id})" class="text-xs bg-primary text-white px-2 py-1 rounded hover:bg-primary-dark">üì§ Update</button>
                    </div>
                `;

                container.appendChild(orderEl);
            });
        }

        function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                updateStats();
                updatePaymentOrderOptions();
                autoSave();
                showNotification(`üìã Status pesanan diubah ke ${newStatus}`, 'success');
                addRecentActivity(`üìã Status pesanan ${order.customerName} diubah ke ${newStatus}`);
            }
        }

        function sendOrderConfirmation(order) {
            let message = `üîî *Konfirmasi Pesanan*\n\nHalo ${order.customerName}!\nTerima kasih sudah memesan:\n\nüì¶ ${order.productName}\nüî¢ Jumlah: ${order.quantity}\nüí∞ Total: Rp ${order.total.toLocaleString()}\n\nMohon konfirmasi alamat pengiriman ya! üòä`;

            const whatsappUrl = `https://wa.me/${order.customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function contactCustomer(phone, name) {
            const message = `Halo ${name}! Ada yang bisa kami bantu? üòä`;
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function sendOrderUpdate(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            let message = '';

            switch(order.status) {
                case 'confirmed':
                    message = `‚úÖ Pesanan Anda telah dikonfirmasi!\n\nHalo ${order.customerName}, pesanan ${order.productName} sudah kami konfirmasi. Segera diproses ya! üòä`;
                    break;
                case 'paid':
                    message = `üí∞ Pembayaran diterima!\n\nHalo ${order.customerName}, pembayaran untuk ${order.productName} sudah kami terima. Pesanan segera diproses! üöÄ`;
                    break;
                case 'shipped':
                    message = `üöö Pesanan dalam perjalanan!\n\nHalo ${order.customerName}, pesanan ${order.productName} sudah dikirim. Mohon ditunggu ya! üì¶`;
                    break;
                case 'completed':
                    message = `üéâ Pesanan selesai!\n\nTerima kasih ${order.customerName}! Semoga puas dengan ${order.productName}. Jangan lupa review ya! ‚≠ê`;
                    break;
                default:
                    message = `üìã Update pesanan ${order.productName} untuk ${order.customerName}`;
            }

            const whatsappUrl = `https://wa.me/${order.customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Customer Management
        function renderCustomers() {
            const container = document.getElementById('customers-list');
            if (!container) return;

            const searchTerm = document.getElementById('search-customers')?.value.toLowerCase() || '';

            let filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) || 
                customer.phone.includes(searchTerm)
            );

            filteredCustomers.sort((a, b) => b.totalSpent - a.totalSpent);

            container.innerHTML = '';

            if (filteredCustomers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada pelanggan</p>';
                return;
            }

            filteredCustomers.forEach((customer, index) => {
                const customerEl = document.createElement('div');
                customerEl.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                customerEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <h4 class="font-medium text-gray-800 dark:text-white">${customer.name}</h4>
                                ${index < 10 ? '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">üëë VIP</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">üì± ${customer.phone}</p>
                            <div class="flex justify-between mt-2">
                                <span class="text-xs text-gray-500 dark:text-gray-400">${customer.totalOrders} pesanan</span>
                                <span class="text-xs font-semibold text-primary">Rp ${customer.totalSpent.toLocaleString()}</span>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Terakhir: ${new Date(customer.lastOrder).toLocaleDateString('id-ID')}</p>
                        </div>
                        <button onclick="contactCustomer('${customer.phone}', '${customer.name}')" class="ml-3 text-whatsapp hover:text-whatsapp/80">üí¨</button>
                    </div>
                `;
                container.appendChild(customerEl);
            });
        }

        // Payment System
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const orderId = document.getElementById('payment-order').value;
            const method = document.getElementById('payment-method').value;
            const amount = parseInt(document.getElementById('payment-amount').value);
            const notes = document.getElementById('payment-notes').value;

            if (!orderId) {
                showNotification('‚ùå Pilih pesanan terlebih dahulu!', 'error');
                return;
            }

            const order = orders.find(o => o.id == orderId);
            if (!order) {
                showNotification('‚ùå Pesanan tidak ditemukan!', 'error');
                return;
            }

            if (amount < order.total) {
                showNotification('‚ùå Jumlah pembayaran kurang!', 'error');
                return;
            }

            const payment = {
                id: Date.now(),
                orderId: parseInt(orderId),
                method,
                amount,
                notes,
                date: new Date().toISOString(),
                change: amount - order.total
            };

            payments.push(payment);
            order.status = 'paid';
            order.paymentDate = new Date().toISOString();

            // Auto print if enabled and printer connected
            if (settings.autoStruk && settings.printerConnected) {
                try {
                    const receiptText = generateReceiptText(order, payment);
                    await printToThermalPrinter(receiptText);
                    showNotification('‚úÖ Pembayaran dikonfirmasi & struk dicetak!', 'success');
                } catch (error) {
                    showNotification('‚úÖ Pembayaran dikonfirmasi, gagal cetak struk!', 'warning');
                }
            } else {
                showNotification('‚úÖ Pembayaran berhasil dikonfirmasi!', 'success');
            }

            this.reset();
            document.getElementById('payment-details').classList.add('hidden');

            renderOrders();
            updatePaymentOrderOptions();
            updateReceiptPreview(order, payment);
            updateStats();
            autoSave();

            addRecentActivity(`üí∞ Pembayaran diterima dari ${order.customerName}`);
        });

        function updatePaymentOrderOptions() {
            const select = document.getElementById('payment-order');
            if (!select) return;

            const unpaidOrders = orders.filter(o => o.status === 'confirmed' || o.status === 'pending');

            select.innerHTML = '<option value="">Pilih pesanan...</option>';

            unpaidOrders.forEach(order => {
                const option = document.createElement('option');
                option.value = order.id;
                option.textContent = `#${order.id} - ${order.customerName} - Rp ${order.total.toLocaleString()}`;
                option.dataset.total = order.total;
                option.dataset.customer = order.customerName;
                option.dataset.product = order.productName;
                option.dataset.quantity = order.quantity;
                option.dataset.phone = order.customerPhone;
                select.appendChild(option);
            });
        }

        document.getElementById('payment-order').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const detailsDiv = document.getElementById('payment-details');
            const infoDiv = document.getElementById('payment-order-info');
            const amountInput = document.getElementById('payment-amount');

            if (this.value) {
                const total = parseInt(selectedOption.dataset.total);
                const customer = selectedOption.dataset.customer;
                const product = selectedOption.dataset.product;
                const quantity = selectedOption.dataset.quantity;

                infoDiv.innerHTML = `
                    <div class="flex justify-between"><span>Pelanggan:</span><span>${customer}</span></div>
                    <div class="flex justify-between"><span>Produk:</span><span>${product}</span></div>
                    <div class="flex justify-between"><span>Jumlah:</span><span>${quantity}</span></div>
                    <div class="flex justify-between font-bold"><span>Total:</span><span>Rp ${total.toLocaleString()}</span></div>
                `;

                amountInput.value = total;
                detailsDiv.classList.remove('hidden');

                const order = orders.find(o => o.id == this.value);
                updateReceiptPreview(order);
            } else {
                detailsDiv.classList.add('hidden');
                updateReceiptPreview();
            }
        });

        // Enhanced Bluetooth Printer Functions
        async function connectPrinter() {
            const connectBtn = document.getElementById('connect-printer-btn');
            const btnText = document.getElementById('connect-btn-text');

            if (!navigator.bluetooth) {
                showNotification('‚ùå Browser tidak mendukung Web Bluetooth!', 'error');
                return;
            }

            try {
                connectBtn.disabled = true;
                btnText.innerHTML = 'üîç Mencari...';
                connectBtn.className = 'w-full px-4 py-2 bg-secondary text-white rounded-md cursor-not-allowed';

                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['000018f0-0000-1000-8000-00805f9b34fb'] },
                        { namePrefix: 'BT-' },
                        { namePrefix: 'MTP-' },
                        { namePrefix: 'POS-' }
                    ],
                    optionalServices: [
                        '000018f0-0000-1000-8000-00805f9b34fb',
                        '49535343-fe7d-4ae5-8fa9-9fafd205e455'
                    ]
                });

                btnText.innerHTML = 'üîÑ Menghubungkan...';
                bluetoothDevice = device;

                device.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                bluetoothCharacteristic = await service.getCharacteristic('000018f1-0000-1000-8000-00805f9b34fb');

                settings.printerConnected = true;
                settings.printerDevice = { name: device.name, id: device.id };

                updatePrinterStatus(true, device.name);
                autoSave();

                showNotification(`‚úÖ Printer "${device.name}" terhubung!`, 'success');

            } catch (error) {
                console.error('Error connecting to printer:', error);
                showNotification(`‚ùå Gagal menghubungkan printer: ${error.message}`, 'error');
                updatePrinterStatus(false);
            } finally {
                connectBtn.disabled = false;
                btnText.innerHTML = 'üîç Hubungkan Printer';
                connectBtn.className = 'w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-all';
            }
        }

        function onDisconnected(event) {
            console.log('Printer disconnected:', event.target.name);
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            settings.printerConnected = false;
            settings.printerDevice = null;
            updatePrinterStatus(false);
            autoSave();
            showNotification('üîå Printer terputus', 'warning');
        }

        function updatePrinterStatus(connected, deviceName = '') {
            const statusElement = document.getElementById('printer-connection-status');
            const statusIcon = document.getElementById('printer-status-icon');
            const testBtn = document.getElementById('test-print-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const menuStatus = document.getElementById('printer-menu-status');

            if (connected) {
                statusElement.textContent = `Terhubung: ${deviceName}`;
                statusElement.className = 'text-sm text-green-600 dark:text-green-400';
                statusIcon.className = 'w-3 h-3 bg-green-500 rounded-full';

                testBtn.disabled = false;
                testBtn.className = 'bg-secondary text-white py-2 px-3 rounded-md hover:bg-blue-600 transition-colors text-sm';
                disconnectBtn.classList.remove('hidden');

                menuStatus.textContent = `üñ®Ô∏è ${deviceName}`;
            } else {
                statusElement.textContent = 'Tidak terhubung';
                statusElement.className = 'text-sm text-gray-600 dark:text-gray-400';
                statusIcon.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';

                testBtn.disabled = true;
                testBtn.className = 'bg-gray-400 text-white py-2 px-3 rounded-md cursor-not-allowed text-sm';
                disconnectBtn.classList.add('hidden');

                menuStatus.textContent = 'Hubungkan Printer';
            }
        }

        function disconnectPrinter() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            settings.printerConnected = false;
            settings.printerDevice = null;
            updatePrinterStatus(false);
            autoSave();
            showNotification('üîå Printer berhasil diputus', 'info');
        }

        async function printToThermalPrinter(receiptText) {
            if (!bluetoothCharacteristic) {
                throw new Error('Printer tidak terhubung');
            }

            try {
                const ESC = 0x1B;
                const GS = 0x1D;

                let commands = [ESC, 0x40]; // Initialize
                commands.push(...[ESC, 0x74, 0x00]); // Character set

                const encoder = new TextEncoder();
                const textBytes = encoder.encode(receiptText);
                commands.push(...textBytes);

                commands.push(...[GS, 0x56, 0x00]); // Cut paper

                const chunkSize = 20;
                for (let i = 0; i < commands.length; i += chunkSize) {
                    const chunk = commands.slice(i, i + chunkSize);
                    await bluetoothCharacteristic.writeValue(new Uint8Array(chunk));
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                return true;
            } catch (error) {
                console.error('Print error:', error);
                throw error;
            }
        }

        async function testPrint() {
            if (!settings.printerConnected || !bluetoothCharacteristic) {
                showNotification('‚ùå Printer belum terhubung!', 'error');
                return;
            }

            const testReceipt = generateReceiptText({
                id: 'TEST001',
                customerName: 'Test Customer',
                customerPhone: '628123456789',
                productName: 'Test Product',
                quantity: 1,
                price: 25000,
                total: 25000,
                date: new Date().toISOString()
            }, {
                method: 'Test Payment',
                amount: 25000,
                notes: 'Test print'
            });

            try {
                await printToThermalPrinter(testReceipt);
                showNotification('‚úÖ Test print berhasil!', 'success');
            } catch (error) {
                showNotification(`‚ùå Test print gagal: ${error.message}`, 'error');
            }
        }

        function generateReceiptText(order, payment = null) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('id-ID');
            const timeStr = now.toLocaleTimeString('id-ID');

            let receipt = '';
            receipt += '================================\n';
            receipt += `        ${settings.storeName.toUpperCase()}\n`;
            receipt += '================================\n';
            if (settings.storeAddress) {
                receipt += `${settings.storeAddress}\n`;
            }
            if (settings.adminPhone) {
                receipt += `WA: ${settings.adminPhone}\n`;
            }
            receipt += '================================\n';
            receipt += `Tanggal: ${dateStr}\n`;
            receipt += `Waktu  : ${timeStr}\n`;
            receipt += `No Inv : #${order.id}\n`;
            receipt += '================================\n';
            receipt += `Customer: ${order.customerName}\n`;
            if (order.customerPhone) {
                receipt += `Telepon : ${order.customerPhone}\n`;
            }
            receipt += '================================\n';
            receipt += 'DETAIL PEMBELIAN:\n';
            receipt += '--------------------------------\n';
            receipt += `${order.productName}\n`;
            receipt += `${order.quantity} x Rp ${order.price.toLocaleString()}\n`;
            receipt += `                Rp ${order.total.toLocaleString()}\n`;
            receipt += '--------------------------------\n';
            receipt += `TOTAL           Rp ${order.total.toLocaleString()}\n`;

            if (payment) {
                receipt += '================================\n';
                receipt += 'PEMBAYARAN:\n';
                receipt += `Metode  : ${payment.method}\n`;
                receipt += `Dibayar : Rp ${payment.amount.toLocaleString()}\n`;
                if (payment.amount > order.total) {
                    receipt += `Kembalian: Rp ${(payment.amount - order.total).toLocaleString()}\n`;
                }
                receipt += '================================\n';
                receipt += '        LUNAS\n';
            }

            receipt += '================================\n';
            receipt += '       TERIMA KASIH!\n';
            receipt += '================================\n';
            receipt += '\n\n\n';

            return receipt;
        }

        function updateReceiptPreview(order = null, payment = null) {
            const previewElement = document.getElementById('receipt-preview');
            const printBtn = document.getElementById('print-receipt-btn');
            const shareBtn = document.getElementById('share-receipt-btn');

            if (!order) {
                const sampleReceipt = `
                <div class="text-center">
                    <p class="font-bold text-lg">${settings.storeName.toUpperCase()}</p>
                    <p class="text-sm">${settings.storeAddress}</p>
                    <p class="text-center my-3">================================</p>
                    <p class="text-gray-500 dark:text-gray-400">Pilih pesanan untuk preview</p>
                    <p class="text-center my-3">================================</p>
                </div>`;
                previewElement.innerHTML = sampleReceipt;
                printBtn.disabled = true;
                shareBtn.disabled = true;
                return;
            }

            const receiptText = generateReceiptText(order, payment);
            previewElement.innerHTML = `<pre class="whitespace-pre-wrap text-xs text-left">${receiptText}</pre>`;

            printBtn.disabled = false;
            shareBtn.disabled = false;
        }

        async function printReceipt() {
            const orderSelect = document.getElementById('payment-order');
            const selectedOrderId = orderSelect.value;

            if (!selectedOrderId) {
                showNotification('‚ùå Pilih pesanan terlebih dahulu!', 'error');
                return;
            }

            const order = orders.find(o => o.id == selectedOrderId);
            const payment = payments.find(p => p.orderId == selectedOrderId);

            if (!order) {
                showNotification('‚ùå Pesanan tidak ditemukan!', 'error');
                return;
            }

            if (!settings.printerConnected || !bluetoothCharacteristic) {
                showNotification('‚ùå Printer belum terhubung!', 'error');
                return;
            }

            const receiptText = generateReceiptText(order, payment);

            try {
                await printToThermalPrinter(receiptText);
                showNotification('‚úÖ Struk berhasil dicetak!', 'success');
            } catch (error) {
                showNotification(`‚ùå Gagal mencetak: ${error.message}`, 'error');
            }
        }

        function shareReceipt() {
            const orderSelect = document.getElementById('payment-order');
            const selectedOrderId = orderSelect.value;

            if (!selectedOrderId) {
                showNotification('‚ùå Pilih pesanan terlebih dahulu!', 'error');
                return;
            }

            const order = orders.find(o => o.id == selectedOrderId);
            const payment = payments.find(p => p.orderId == selectedOrderId);

            if (!order) {
                showNotification('‚ùå Pesanan tidak ditemukan!', 'error');
                return;
            }

            const receiptText = generateReceiptText(order, payment);
            const message = `üßæ *STRUK PEMBAYARAN*\n\n\`\`\`${receiptText}\`\`\`\n\nTerima kasih! üôè`;

            const whatsappUrl = `https://wa.me/${order.customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Template Management
        function initializeTemplates() {
            if (messageTemplates.length === 0) {
                messageTemplates = [
                    {
                        id: 1,
                        name: "üîî Konfirmasi Pesanan",
                        content: "Halo [NAMA], terima kasih sudah memesan [PRODUK]. Total: Rp [TOTAL]. Mohon konfirmasi alamat pengiriman ya! üòä"
                    },
                    {
                        id: 2,
                        name: "üí≥ Info Pembayaran",
                        content: `Silakan transfer ke:\n${settings.bankInfo}\na.n: ${settings.storeName}\nNominal: Rp [TOTAL]\nKonfirmasi setelah transfer ya! üôè`
                    },
                    {
                        id: 3,
                        name: "üöö Info Pengiriman",
                        content: "Pesanan sudah dikirim! üöö\nNo. Resi: [RESI]\nEkspedisi: [EKSPEDISI]\nTerima kasih! üôè"
                    }
                ];
                autoSave();
            }
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');
            if (!container) return;

            container.innerHTML = '';

            messageTemplates.forEach(template => {
                const templateEl = document.createElement('div');
                templateEl.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                templateEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-medium text-gray-800 dark:text-white">${template.name}</h4>
                        <div class="flex space-x-2">
                            <button onclick="useTemplate(${template.id})" class="text-primary hover:text-primary-dark text-sm">Gunakan</button>
                            <button onclick="editTemplate(${template.id})" class="text-secondary hover:text-blue-800 text-sm">‚úèÔ∏è</button>
                            <button onclick="deleteTemplate(${template.id})" class="text-danger hover:text-red-800 text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</p>
                `;
                container.appendChild(templateEl);
            });
        }

        function addNewTemplate() {
            document.getElementById('edit-template-id').value = '';
            document.getElementById('template-name').value = '';
            document.getElementById('template-content').value = '';
            document.getElementById('template-modal').classList.remove('hidden');
        }

        function editTemplate(id) {
            const template = messageTemplates.find(t => t.id === id);
            if (!template) return;

            document.getElementById('edit-template-id').value = id;
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-content').value = template.content;
            document.getElementById('template-modal').classList.remove('hidden');
        }

        function deleteTemplate(id) {
            showConfirmDialog('Yakin ingin menghapus template ini?', () => {
                messageTemplates = messageTemplates.filter(t => t.id !== id);
                renderTemplates();
                autoSave();
                showNotification('üóëÔ∏è Template berhasil dihapus!', 'success');
            });
        }

        function hideTemplateModal() {
            document.getElementById('template-modal').classList.add('hidden');
        }

        document.getElementById('template-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('edit-template-id').value;
            const name = document.getElementById('template-name').value;
            const content = document.getElementById('template-content').value;

            if (id) {
                const templateIndex = messageTemplates.findIndex(t => t.id === parseInt(id));
                if (templateIndex !== -1) {
                    messageTemplates[templateIndex].name = name;
                    messageTemplates[templateIndex].content = content;
                    showNotification('‚úÖ Template berhasil diperbarui!', 'success');
                }
            } else {
                const newTemplate = {
                    id: Date.now(),
                    name,
                    content
                };
                messageTemplates.push(newTemplate);
                showNotification('‚úÖ Template berhasil ditambahkan!', 'success');
            }

            renderTemplates();
            hideTemplateModal();
            autoSave();
        });

        function useTemplate(templateId) {
            const template = messageTemplates.find(t => t.id === templateId);
            if (!template) return;

            const messageTextarea = document.getElementById('message-text');
            if (messageTextarea) {
                messageTextarea.value = template.content;
            }
        }

        // Broadcast System
        function broadcastToCustomers() {
            document.getElementById('broadcast-modal').classList.remove('hidden');
        }

        function hideBroadcastModal() {
            document.getElementById('broadcast-modal').classList.add('hidden');
        }

        document.getElementById('broadcast-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const target = document.getElementById('broadcast-target').value;
            const message = document.getElementById('broadcast-message').value;
            const includeCatalog = document.getElementById('include-catalog').checked;

            let recipients = [];

            switch(target) {
                case 'all':
                    recipients = customers;
                    break;
                case 'vip':
                    recipients = customers.sort((a, b) => b.totalSpent - a.totalSpent).slice(0, 10);
                    break;
                case 'recent':
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    recipients = customers.filter(c => new Date(c.lastOrder) > thirtyDaysAgo);
                    break;
            }

            if (recipients.length === 0) {
                showNotification('‚ùå Tidak ada penerima!', 'error');
                return;
            }

            let finalMessage = message;
            if (includeCatalog) {
                finalMessage += `\n\nüìã Katalog: ${window.location.href}`;
            }

            const maxRecipients = Math.min(recipients.length, 10);
            recipients.slice(0, maxRecipients).forEach((customer, index) => {
                setTimeout(() => {
                    const personalizedMessage = finalMessage.replace(/\[NAMA\]/g, customer.name);
                    const whatsappUrl = `https://wa.me/${customer.phone}?text=${encodeURIComponent(personalizedMessage)}`;
                    window.open(whatsappUrl, '_blank');
                }, index * 1000);
            });

            hideBroadcastModal();
            showNotification(`üì¢ Broadcast dikirim ke ${maxRecipients} pelanggan!`, 'success');
        });

        // Catalog Generation
        function generateKatalog() {
            let catalog = `üõçÔ∏è *KATALOG ${settings.storeName.toUpperCase()}*\n\n`;

            if (products.length === 0) {
                showNotification('‚ùå Belum ada produk!', 'error');
                return;
            }

            const categories = [...new Set(products.map(p => p.category))];

            categories.forEach(category => {
                const categoryProducts = products.filter(p => p.category === category && p.stock > 0);
                if (categoryProducts.length === 0) return;

                catalog += `üìÇ *${category.toUpperCase()}*\n`;
                categoryProducts.forEach((product, index) => {
                    catalog += `${index + 1}. *${product.name}*\n`;
                    catalog += `   üí∞ Rp ${product.price.toLocaleString()}\n`;
                    catalog += `   üì¶ Stok: ${product.stock}\n`;
                    if (product.description) {
                        catalog += `   üìù ${product.description}\n`;
                    }
                    catalog += `\n`;
                });
            });

            catalog += `üí¨ *CARA ORDER:*\n`;
            catalog += `Ketik: *ORDER [nama produk] [jumlah]*\n\n`;
            catalog += `üìû *CONTACT:*\n`;
            catalog += `WhatsApp: ${settings.adminPhone || 'Belum diatur'}\n\n`;
            catalog += `‚ú® Terima kasih! ‚ú®`;

            document.getElementById('generated-catalog').value = catalog;
            document.getElementById('catalog-modal').classList.remove('hidden');
        }

        function hideCatalogModal() {
            document.getElementById('catalog-modal').classList.add('hidden');
        }

        function copyCatalog() {
            const catalog = document.getElementById('generated-catalog').value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(catalog).then(() => {
                    showNotification('üìã Katalog tersalin!', 'success');
                });
            }
        }

        function shareCatalog() {
            const catalog = document.getElementById('generated-catalog').value;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(catalog)}`;
            window.open(whatsappUrl, '_blank');
            hideCatalogModal();
        }

        // Messaging Functions
        function sendWhatsAppMessage() {
            const phone = document.getElementById('message-phone').value;
            const message = document.getElementById('message-text').value;

            if (!phone || !message) {
                showNotification('‚ùå Mohon isi nomor dan pesan!', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('üì± Pesan dikirim!', 'success');
        }

        function shareToko() {
            const message = `üõçÔ∏è *${settings.storeName}*\n\nKunjungi toko online kami!\nProduk berkualitas üíØ\n\nüì± Order via WhatsApp!`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function quickSummary() {
            const totalProducts = products.length;
            const totalOrders = orders.length;

            const today = new Date().toDateString();
            const todayOrders = orders.filter(o => new Date(o.date).toDateString() === today);
            const todayRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);

            const message = `üìä *RINGKASAN TOKO*\n\n` +
                         `üì¶ Produk: ${totalProducts}\n` +
                         `üìã Pesanan: ${totalOrders}\n` +
                         `üí∞ Hari Ini: Rp ${todayRevenue.toLocaleString()}\n\n` +
                         `${new Date().toLocaleDateString('id-ID')}`;

            showNotification('üìä Ringkasan digenerate!', 'info');

            if (navigator.clipboard) {
                navigator.clipboard.writeText(message);
                showNotification('üìã Tersalin ke clipboard!', 'success');
            }
        }

        // Charts and Statistics
        function initializeCharts() {
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const profitCtx = document.getElementById('profitChart').getContext('2d');

            if (revenueChart) revenueChart.destroy();
            if (profitChart) profitChart.destroy();

            const monthsData = getMonthlyData();

            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: monthsData.labels,
                    datasets: [{
                        label: 'Pendapatan (Rp)',
                        data: monthsData.revenue,
                        borderColor: '#1E40AF',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            profitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: monthsData.labels,
                    datasets: [{
                        label: 'Keuntungan (Rp)',
                        data: monthsData.profit,
                        backgroundColor: 'rgba(5, 150, 105, 0.8)',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function getMonthlyData() {
            const months = [];
            const revenue = [];
            const profit = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toISOString().slice(0, 7);
                const monthName = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });

                months.push(monthName);

                const monthOrders = orders.filter(o => 
                    o.date.slice(0, 7) === monthYear && (o.status === 'completed' || o.status === 'paid')
                );

                const monthRevenue = monthOrders.reduce((sum, order) => sum + order.total, 0);
                const monthProfit = monthOrders.reduce((sum, order) => sum + (order.profit || 0), 0);

                revenue.push(monthRevenue);
                profit.push(monthProfit);
            }

            return { labels: months, revenue, profit };
        }

        function updateStats() {
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('total-orders').textContent = orders.length;

            const completedOrders = orders.filter(o => o.status === 'completed' || o.status === 'paid');
            const totalRevenue = completedOrders.reduce((sum, order) => sum + order.total, 0);
            const totalProfit = completedOrders.reduce((sum, order) => sum + (order.profit || 0), 0);

            document.getElementById('total-revenue').textContent = `Rp ${totalRevenue.toLocaleString()}`;
            document.getElementById('total-profit').textContent = `Rp ${totalProfit.toLocaleString()}`;

            // Today's profit
            const today = new Date().toDateString();
            const todayProfit = orders
                .filter(o => new Date(o.date).toDateString() === today && (o.status === 'completed' || o.status === 'paid'))
                .reduce((sum, order) => sum + (order.profit || 0), 0);
            document.getElementById('today-profit').textContent = `Rp ${todayProfit.toLocaleString()}`;

            // Monthly profit
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthlyProfit = orders
                .filter(o => o.date.slice(0, 7) === thisMonth && (o.status === 'completed' || o.status === 'paid'))
                .reduce((sum, order) => sum + (order.profit || 0), 0);

            document.getElementById('monthly-profit').textContent = `Rp ${monthlyProfit.toLocaleString()}`;
            document.getElementById('monthly-revenue').textContent = `Rp ${monthlyProfit.toLocaleString()}`;
            document.getElementById('monthly-profit-display').textContent = `Rp ${monthlyProfit.toLocaleString()}`;
        }

        // Recent Activity
        let recentActivities = [];

        function addRecentActivity(activity) {
            const now = new Date();
            recentActivities.unshift({
                text: activity,
                time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                date: now.toLocaleDateString('id-ID')
            });

            // Keep only last 10 activities
            recentActivities = recentActivities.slice(0, 10);
            renderRecentActivity();
        }

        function renderRecentActivity() {
            const container = document.getElementById('recent-activity');
            if (!container) return;

            container.innerHTML = '';

            if (recentActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada aktivitas</p>';
                return;
            }

            recentActivities.forEach(activity => {
                const activityEl = document.createElement('div');
                activityEl.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                activityEl.innerHTML = `
                    <span class="text-sm text-gray-800 dark:text-white">${activity.text}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400">${activity.time}</span>
                `;
                container.appendChild(activityEl);
            });
        }

        // Export Functions
        function exportAllData() {
            const report = {
                summary: {
                    totalProducts: products.length,
                    totalOrders: orders.length,
                    totalCustomers: customers.length,
                    totalRevenue: orders.filter(o => o.status === 'completed' || o.status === 'paid').reduce((sum, o) => sum + o.total, 0),
                    totalProfit: orders.filter(o => o.status === 'completed' || o.status === 'paid').reduce((sum, o) => sum + (o.profit || 0), 0)
                },
                products,
                orders,
                customers,
                payments,
                settings,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laporan-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('üìä Data berhasil diexport!', 'success');
        }

        function exportCustomers() {
            if (customers.length === 0) {
                showNotification('‚ùå Belum ada data pelanggan!', 'error');
                return;
            }

            const csvHeader = 'Nama,Telepon,Total Pesanan,Total Belanja\n';
            const csvData = customers.map(c => 
                `"${c.name}","${c.phone}",${c.totalOrders},${c.totalSpent}`
            ).join('\n');

            const blob = new Blob([csvHeader + csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pelanggan-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('üìä Data pelanggan diexport!', 'success');
        }

        function clearAllData() {
            if (userRole !== 'owner') {
                showNotification('‚ùå Hanya Owner yang dapat menghapus data!', 'error');
                return;
            }

            showConfirmDialog('‚ö†Ô∏è YAKIN HAPUS SEMUA DATA?', () => {
                const storageKey = isGoogleLogin && googleUser ? 
                    `tokoData_${googleUser.id}` : 'tokoOnlineData';
                
                localStorage.removeItem(storageKey);
                
                products = [];
                orders = [];
                customers = [];
                messageTemplates = [];
                payments = [];
                recentActivities = [];
                
                settings = {
                    storeName: 'Kisara Jahit',
                    adminPhone: '',
                    bankInfo: 'BCA: 1234567890',
                    storeAddress: 'Kemiling, Bandar Lampung',
                    printerConnected: false,
                    printerDevice: null,
                    autoStruk: true
                };

                initializeApp();
                showNotification('üóëÔ∏è Semua data berhasil dihapus!', 'success');
            });
        }

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-white shadow-lg animate-fade-in ${
                type === 'success' ? 'bg-success' : 
                type === 'error' ? 'bg-danger' : 
                type === 'warning' ? 'bg-warning' :
                'bg-primary'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Batal</button>
                        <button class="px-4 py-2 bg-danger text-white hover:bg-red-700 rounded" onclick="this.closest('.fixed').remove(); (${onConfirm})()">Konfirmasi</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Event Listeners Setup
        function setupEventListeners() {
            const searchInput = document.getElementById('search-products');
            const categoryFilter = document.getElementById('filter-category');
            const searchCustomers = document.getElementById('search-customers');
            const filterOrders = document.getElementById('filter-orders');

            if (searchInput) searchInput.addEventListener('input', renderProducts);
            if (categoryFilter) categoryFilter.addEventListener('change', renderProducts);
            if (searchCustomers) searchCustomers.addEventListener('input', renderCustomers);
            if (filterOrders) filterOrders.addEventListener('change', renderOrders);

            // Order total calculation
            const productSelect = document.getElementById('order-product');
            const quantityInput = document.getElementById('order-quantity');
            const totalInput = document.getElementById('order-total');

            function updateTotal() {
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const price = selectedOption.dataset.price ? parseInt(selectedOption.dataset.price) : 0;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = price * quantity;

                totalInput.value = total > 0 ? `Rp ${total.toLocaleString()}` : '';
            }

            if (productSelect && quantityInput) {
                productSelect.addEventListener('change', updateTotal);
                quantityInput.addEventListener('input', updateTotal);
            }
        }

        function updateOrderProductOptions() {
            const select = document.getElementById('order-product');
            if (!select) return;

            select.innerHTML = '<option value="">Pilih produk...</option>';

            products.filter(p => p.stock > 0).forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - Rp ${product.price.toLocaleString()} (Stok: ${product.stock})`;
                option.dataset.price = product.price;
                select.appendChild(option);
            });
        }

        function updateFilterCategories() {
            const select = document.getElementById('filter-category');
            if (!select) return;

            const categories = [...new Set(products.map(p => p.category))];
            const currentValue = select.value;

            select.innerHTML = '<option value="">Semua Kategori</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });

            select.value = currentValue;
        }

        // Initialize with sample data
        function initSampleData() {
            products = [
                {
                    id: 1,
                    name: "Kaos Polos Premium",
                    price: 75000,
                    cost: 45000,
                    stock: 50,
                    category: "Fashion",
                    description: "Kaos polos berbahan cotton combed 30s",
                    image: "",
                    created: new Date().toISOString()
                },
                {
                    id: 2,
                    name: "Sepatu Sneakers",
                    price: 250000,
                    cost: 180000,
                    stock: 20,
                    category: "Fashion", 
                    description: "Sepatu sneakers casual untuk pria dan wanita",
                    image: "",
                    created: new Date().toISOString()
                }
            ];

            initializeTemplates();
            initializeApp();
            autoSave();
        }

        function initializeApp() {
            updateStats();
            renderProducts();
            renderOrders();
            renderCustomers();
            renderTemplates();
            renderRecentActivity();
            updateOrderProductOptions();
            updatePaymentOrderOptions();
            updateFilterCategories();
            updatePrinterStatus(settings.printerConnected, settings.printerDevice?.name);
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');

            setupEventListeners();

            // Add recent activity for demo
            addRecentActivity('üöÄ Aplikasi dimulai');
        });
    </script>
</body>
</html>
