<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisara Jahit - Smart POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        'primary-dark': '#1E3A8A',
                        'primary-light': '#3B82F6',
                        secondary: '#60A5FA',
                        accent: '#93C5FD',
                        whatsapp: '#25D366',
                        success: '#059669',
                        warning: '#D97706',
                        danger: '#DC2626'
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out'
                    }
                }
            }
        }

        tailwind.config.theme.extend.keyframes = {
            slideIn: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(0)' }
            },
            fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary to-primary-dark">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl text-white">ğŸ‘—</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">KISARA JAHIT</h1>
                <p class="text-gray-600 dark:text-gray-400">Smart POS System</p>
            </div>

            <!-- Login Tabs -->
            <div class="mb-6">
                <div class="flex border-b border-gray-200 dark:border-gray-600">
                    <button id="login-tab" onclick="switchLoginTab('login')" class="flex-1 py-2 text-center border-b-2 border-primary text-primary font-medium">
                        Login
                    </button>
                    <button id="register-tab" onclick="switchLoginTab('register')" class="flex-1 py-2 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Daftar
                    </button>
                </div>
            </div>

            <!-- Google Sign-In -->
            <div class="mb-6">
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID"
                     data-context="signin"
                     data-ux_mode="popup"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                
                <div class="g_id_signin" 
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="outline"
                     data-text="signin_with"
                     data-size="large"
                     data-logo_alignment="left"
                     data-width="100%">
                </div>
                
                <!-- Fallback Button for Demo -->
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-all mt-3">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Demo: Masuk dengan Google
                </button>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white dark:bg-gray-800 text-gray-500">atau</span>
                </div>
            </div>

            <!-- Login Form -->
            <div id="login-form-container" class="space-y-4">
                <form id="manual-login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email atau Username</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="password" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all pr-12">
                            <button type="button" onclick="togglePassword('password')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                ğŸ‘ï¸
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-primary-dark transition-all font-medium transform hover:scale-105">
                        ğŸ” Login
                    </button>
                </form>

                <!-- Demo Account -->
                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <p class="text-xs text-blue-800 dark:text-blue-200 text-center">
                        Demo: Username: <strong>admin</strong> | Password: <strong>admin123</strong>
                    </p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form-container" class="space-y-4 hidden">
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Lengkap</label>
                        <input type="text" id="register-name" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                        <input type="text" id="register-username" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="register-password" required minlength="6" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all pr-12">
                            <button type="button" onclick="togglePassword('register-password')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                ğŸ‘ï¸
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Konfirmasi Password</label>
                        <div class="relative">
                            <input type="password" id="register-password-confirm" required minlength="6" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary transition-all pr-12">
                            <button type="button" onclick="togglePassword('register-password-confirm')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                ğŸ‘ï¸
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-success text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-all font-medium transform hover:scale-105">
                        ğŸ“ Daftar Akun
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Mobile Hamburger Menu Overlay -->
        <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

        <!-- Sidebar Menu -->
        <div id="sidebar" class="fixed left-0 top-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full transition-transform duration-300 z-50">
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Menu</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400" id="sidebar-user">ğŸ‘‘ Administrator</p>
                </div>
                <button onclick="closeSidebar()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <nav class="p-4 space-y-2">
                <button onclick="showSection('dashboard')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ“Š</span>
                    Dashboard
                </button>
                <button onclick="showSection('katalog')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ›ï¸</span>
                    Katalog Produk
                </button>
                <button onclick="showSection('kasir')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ›’</span>
                    Kasir & Pembayaran
                </button>
                <button onclick="showSection('pesanan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ“‹</span>
                    Kelola Pesanan
                </button>
                <button onclick="showSection('piutang')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ’³</span>
                    Piutang & DP
                </button>
                <button onclick="showSection('pelanggan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ‘¥</span>
                    Pelanggan
                </button>
                <button onclick="showSection('pesan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">ğŸ’¬</span>
                    Template Pesan
                </button>
                <button onclick="showSection('laporan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all owner-only">
                    <span class="mr-3">ğŸ“ˆ</span>
                    Laporan & Analisis
                </button>
                <button onclick="showSection('pengaturan')" class="menu-item w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-primary hover:text-white transition-all">
                    <span class="mr-3">âš™ï¸</span>
                    Pengaturan
                </button>
                
                <hr class="my-4 border-gray-200 dark:border-gray-700">
                
                <button onclick="connectPrinter()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-secondary hover:text-white transition-all">
                    <span class="mr-3">ğŸ–¨ï¸</span>
                    <span id="printer-menu-status">Hubungkan Printer</span>
                </button>
                <button onclick="quickSummary()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-secondary hover:text-white transition-all">
                    <span class="mr-3">ğŸ“Š</span>
                    Ringkasan Cepat
                </button>
                <button onclick="shareToko()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-whatsapp hover:text-white transition-all">
                    <span class="mr-3">ğŸ“±</span>
                    Share Toko
                </button>
                
                <hr class="my-4 border-gray-200 dark:border-gray-700">
                
                <button onclick="logout()" class="w-full flex items-center px-4 py-3 text-left rounded-lg hover:bg-danger hover:text-white transition-all">
                    <span class="mr-3">ğŸšª</span>
                    Logout
                </button>
            </nav>
        </div>

        <!-- Header -->
        <header class="bg-gradient-to-r from-primary to-primary-dark text-white shadow-lg">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button onclick="openSidebar()" class="mr-4 p-2 rounded-lg hover:bg-white/10 transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold">KISARA JAHIT</h1>
                            <p class="text-sm text-blue-200" id="section-title">Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="hidden sm:block text-right">
                            <div class="text-sm" id="header-user">ğŸ‘‘ Administrator</div>
                            <div class="text-xs text-blue-200" id="save-status">ğŸ’¾ AUTO SAVE</div>
                        </div>
                        <div id="user-avatar" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                            <span class="text-sm">ğŸ‘¤</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 pb-20">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-primary to-primary-light text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ“¦</span>
                            <div>
                                <p class="text-sm opacity-90">Produk</p>
                                <p id="total-products" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-secondary to-accent text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ“‹</span>
                            <div>
                                <p class="text-sm opacity-90">Pesanan</p>
                                <p id="total-orders" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-success to-green-500 text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ’°</span>
                            <div>
                                <p class="text-sm opacity-90">Hari Ini</p>
                                <p id="today-profit" class="text-lg font-bold">Rp 0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-warning to-orange-500 text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ’</span>
                            <div>
                                <p class="text-sm opacity-90">Bulan Ini</p>
                                <p id="monthly-profit" class="text-lg font-bold">Rp 0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ’³</span>
                            <div>
                                <p class="text-sm opacity-90">Piutang</p>
                                <p id="total-piutang" class="text-lg font-bold">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button onclick="showSection('katalog')" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-all border-l-4 border-primary">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">ğŸ›ï¸</span>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Kelola Produk</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Tambah & edit produk</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="showSection('kasir')" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-all border-l-4 border-secondary">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">ğŸ›’</span>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Kasir</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Buat pesanan & bayar</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="showSection('piutang')" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-all border-l-4 border-red-500">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">ğŸ’³</span>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Piutang & DP</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Kelola pembayaran</p>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ“ˆ Aktivitas Terbaru</h3>
                    <div id="recent-activity" class="space-y-3">
                        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada aktivitas</p>
                    </div>
                </div>
            </div>

            <!-- Kasir & Pembayaran Section -->
            <div id="kasir-section" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Kasir Form -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ›’ Kasir & Pembayaran</h3>
                        <form id="kasir-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Pelanggan *</label>
                                    <input type="text" id="kasir-customer-name" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">No. WhatsApp</label>
                                    <input type="tel" id="kasir-customer-phone" placeholder="628123456789" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                            </div>

                            <!-- Jadwal Proses -->
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ“… Jadwal Proses</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mulai Proses</label>
                                        <input type="date" id="kasir-start-date" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimasi Selesai</label>
                                        <input type="date" id="kasir-due-date" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Catatan Khusus</label>
                                    <textarea id="kasir-special-notes" rows="2" placeholder="Catatan khusus untuk pesanan..." class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                                </div>
                            </div>

                            <!-- Cart Items -->
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-gray-800 dark:text-white">Keranjang Belanja</h4>
                                    <button type="button" onclick="clearCart()" class="text-sm text-danger hover:text-red-700">ğŸ—‘ï¸ Kosongkan</button>
                                </div>
                                
                                <div class="space-y-3 mb-3">
                                    <div class="grid grid-cols-3 gap-3">
                                        <select id="add-product" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="">Pilih produk...</option>
                                        </select>
                                        <input type="number" id="add-quantity" min="1" value="1" placeholder="Qty" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <button type="button" onclick="addToCart()" class="bg-primary text-white px-3 py-2 rounded text-sm hover:bg-primary-dark">â• Tambah</button>
                                    </div>
                                </div>

                                <div id="cart-items" class="space-y-2 max-h-40 overflow-y-auto">
                                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">Keranjang kosong</p>
                                </div>

                                <div class="border-t border-gray-200 dark:border-gray-700 pt-3 mt-3">
                                    <div class="flex justify-between font-semibold text-lg">
                                        <span>Total:</span>
                                        <span id="cart-total" class="text-primary">Rp 0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment -->
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ’³ Pembayaran</h4>
                                
                                <!-- Payment Type -->
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipe Pembayaran</label>
                                    <select id="kasir-payment-type" onchange="togglePaymentFields()" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="full">ğŸ’° Lunas</option>
                                        <option value="dp">ğŸ’³ DP (Down Payment)</option>
                                        <option value="credit">ğŸ“ Piutang</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Metode</label>
                                        <select id="kasir-payment-method" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="Tunai">ğŸ’µ Tunai</option>
                                            <option value="Transfer Bank">ğŸ¦ Transfer Bank</option>
                                            <option value="E-Wallet">ğŸ’³ E-Wallet</option>
                                            <option value="QRIS">ğŸ“± QRIS</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" id="payment-amount-label">Dibayar</label>
                                        <input type="number" id="kasir-payment-amount" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>

                                <!-- DP Specific Fields -->
                                <div id="dp-fields" class="hidden mb-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sisa Pembayaran</label>
                                            <input type="text" id="remaining-payment" readonly class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Pelunasan</label>
                                            <input type="date" id="dp-due-date" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        </div>
                                    </div>
                                </div>

                                <!-- Credit Specific Fields -->
                                <div id="credit-fields" class="hidden mb-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jatuh Tempo Piutang</label>
                                        <input type="date" id="credit-due-date" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div class="flex justify-between text-sm">
                                        <span>Kembalian:</span>
                                        <span id="change-amount" class="font-medium">Rp 0</span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <textarea id="kasir-notes" rows="2" placeholder="Catatan pembayaran..." class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-success text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                                âœ… Proses & Print Struk
                            </button>
                        </form>
                    </div>

                    <!-- Receipt & Printer -->
                    <div class="space-y-6">
                        <!-- Printer Status -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ–¨ï¸ Printer Bluetooth</h3>
                            
                            <div class="p-4 bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-700 dark:to-blue-900/20 rounded-lg mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div id="printer-status-icon" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                        <div>
                                            <p class="font-medium text-gray-800 dark:text-white">Status Printer</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400" id="printer-connection-status">Tidak terhubung</p>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="connectPrinter()" id="connect-printer-btn" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-all">
                                    <span id="connect-btn-text">ğŸ” Hubungkan Printer</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="testPrint()" id="test-print-btn" class="bg-secondary text-white py-2 px-3 rounded-md hover:bg-blue-600 transition-colors text-sm">
                                    ğŸ§ª Test Print
                                </button>
                                <button onclick="disconnectPrinter()" id="disconnect-btn" class="hidden bg-danger text-white py-2 px-3 rounded-md hover:bg-red-700 transition-colors text-sm">
                                    ğŸ”Œ Disconnect
                                </button>
                            </div>
                        </div>

                        <!-- Receipt Preview -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ§¾ Preview Struk</h3>
                            <div class="bg-white dark:bg-gray-900 p-6 border border-gray-200 dark:border-gray-700 rounded-lg font-mono text-sm max-h-64 overflow-y-auto" id="receipt-preview">
                                <div class="text-center">
                                    <p class="font-bold text-lg">KISARA JAHIT</p>
                                    <p class="text-sm">Kemiling, Bandar Lampung</p>
                                    <p class="text-center my-3">================================</p>
                                    <p class="text-gray-500 dark:text-gray-400">Tambahkan item ke keranjang</p>
                                    <p class="text-center my-3">================================</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Piutang & DP Section -->
            <div id="piutang-section" class="section hidden">
                <div class="space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg p-6">
                            <div class="flex items-center">
                                <span class="text-3xl mr-4">ğŸ’³</span>
                                <div>
                                    <h3 class="text-lg font-semibold">Total Piutang</h3>
                                    <p id="piutang-summary-total" class="text-2xl font-bold">Rp 0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg p-6">
                            <div class="flex items-center">
                                <span class="text-3xl mr-4">â°</span>
                                <div>
                                    <h3 class="text-lg font-semibold">Jatuh Tempo</h3>
                                    <p id="overdue-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg p-6">
                            <div class="flex items-center">
                                <span class="text-3xl mr-4">ğŸ’°</span>
                                <div>
                                    <h3 class="text-lg font-semibold">DP Belum Lunas</h3>
                                    <p id="dp-pending-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Piutang List -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">ğŸ’³ Daftar Piutang & DP</h3>
                            <div class="flex space-x-2">
                                <select id="piutang-filter" onchange="filterPiutang()" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="all">Semua</option>
                                    <option value="dp">DP</option>
                                    <option value="credit">Piutang</option>
                                    <option value="overdue">Jatuh Tempo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="piutang-list" class="space-y-3">
                            <p class="text-gray-500 dark:text-gray-400 text-center py-8">Belum ada piutang atau DP</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other sections remain the same but simplified for brevity -->
            <div id="katalog-section" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ›ï¸ Katalog Produk</h3>
                    <p class="text-gray-500 dark:text-gray-400">Fitur katalog produk akan segera hadir...</p>
                </div>
            </div>

            <div id="pesanan-section" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ“‹ Kelola Pesanan</h3>
                    <div id="orders-list" class="space-y-3">
                        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada pesanan</p>
                    </div>
                </div>
            </div>

            <div id="pelanggan-section" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ‘¥ Database Pelanggan</h3>
                    <div id="customers-list" class="space-y-3">
                        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada pelanggan</p>
                    </div>
                </div>
            </div>

            <div id="pesan-section" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ’¬ Template Pesan</h3>
                    <p class="text-gray-500 dark:text-gray-400">Fitur template pesan akan segera hadir...</p>
                </div>
            </div>

            <div id="laporan-section" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ“ˆ Laporan & Analisis</h3>
                    <p class="text-gray-500 dark:text-gray-400">Fitur laporan akan segera hadir...</p>
                </div>
            </div>

            <!-- Pengaturan Section -->
            <div id="pengaturan-section" class="section hidden">
                <div class="space-y-6">
                    <!-- Store Settings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸª Pengaturan Toko</h3>
                        <form id="store-settings-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Toko</label>
                                <input type="text" id="store-name-input" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor WhatsApp</label>
                                <input type="tel" id="admin-phone-input" placeholder="628123456789" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Info Bank</label>
                                <input type="text" id="bank-info-input" placeholder="BCA: 1234567890" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alamat Toko</label>
                                <textarea id="store-address-input" rows="2" placeholder="Alamat lengkap toko" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                            <button type="submit" class="bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-dark transition-colors">
                                ğŸ’¾ Simpan Pengaturan
                            </button>
                        </form>
                    </div>

                    <!-- Account Settings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">ğŸ‘¤ Pengaturan Akun</h3>
                        
                        <!-- Google Account Status -->
                        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-white">Status Akun</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400" id="account-type-status">Manual Account</p>
                                </div>
                                <div id="google-account-status" class="text-sm">
                                    <span class="text-gray-500">Akun Manual</span>
                                </div>
                            </div>
                        </div>

                        <!-- Change Password (for manual accounts) -->
                        <div id="change-password-section" class="mb-6">
                            <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ”’ Ubah Password</h4>
                            <form id="change-password-form" class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password Lama</label>
                                    <input type="password" id="old-password" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password Baru</label>
                                    <input type="password" id="new-password" required minlength="6" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Konfirmasi Password Baru</label>
                                    <input type="password" id="confirm-new-password" required minlength="6" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                                </div>
                                <button type="submit" class="bg-warning text-white py-2 px-4 rounded-md hover:bg-orange-700 transition-colors">
                                    ğŸ”’ Ubah Password
                                </button>
                            </form>
                        </div>

                        <div class="space-y-3">
                            <button onclick="exportAllData()" class="w-full bg-secondary text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">
                                ğŸ“Š Export Semua Data
                            </button>
                            
                            <button onclick="showConfirmDialog('âš ï¸ YAKIN HAPUS SEMUA DATA? Tindakan ini tidak dapat dibatalkan!', clearAllData)" class="w-full bg-danger text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors owner-only">
                                ğŸ—‘ï¸ Reset Semua Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ENHANCED CLOUD STORAGE SYSTEM
        const CLOUD_STORAGE_KEY = 'kisara_shared_data';
        
        // ENHANCED USER SYSTEM WITH GOOGLE OAUTH & SHARED STORAGE
        let currentUser = null;
        let userRole = null;
        let googleUser = null;
        let isGoogleLogin = false;

        // Shared storage for multi-device access
        let sharedData = {
            users: [
                { 
                    id: 1, 
                    username: 'admin', 
                    email: 'admin@kisarajahit.com',
                    password: 'admin123', 
                    role: 'owner', 
                    name: 'Administrator',
                    created: new Date().toISOString(),
                    lastLogin: null
                }
            ],
            globalProducts: [],
            globalOrders: [],
            globalCustomers: [],
            globalSettings: {
                storeName: 'Kisara Jahit',
                adminPhone: '',
                bankInfo: 'BCA: 1234567890',
                storeAddress: 'Kemiling, Bandar Lampung'
            }
        };

        // Individual user data
        let products = [];
        let orders = [];
        let customers = [];
        let messageTemplates = [];
        let payments = [];
        let piutangData = [];
        let settings = {
            storeName: 'Kisara Jahit',
            adminPhone: '',
            bankInfo: 'BCA: 1234567890',
            storeAddress: 'Kemiling, Bandar Lampung',
            printerConnected: false,
            printerDevice: null,
            autoStruk: true
        };
        let recentActivities = [];
        let cart = [];

        // GOOGLE OAUTH INTEGRATION
        let gapi_loaded = false;
        let google_loaded = false;

        function handleCredentialResponse(response) {
            try {
                // Decode the JWT token to get user info
                const userInfo = parseJwt(response.credential);
                
                const googleUserData = {
                    id: 'google_' + userInfo.sub,
                    email: userInfo.email,
                    name: userInfo.name,
                    picture: userInfo.picture
                };

                showNotification('ğŸ”„ Login Google berhasil!', 'success');
                loginWithGoogle(googleUserData);
            } catch (error) {
                console.error('Google login error:', error);
                showNotification('âŒ Gagal login dengan Google!', 'error');
            }
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Initialize Google API
        function initializeGoogleAPI() {
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: "YOUR_GOOGLE_CLIENT_ID", // Replace with actual client ID
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });
                
                // Render the sign-in button
                google.accounts.id.renderButton(
                    document.querySelector('.g_id_signin'),
                    { 
                        theme: "outline", 
                        size: "large",
                        text: "signin_with",
                        width: "100%"
                    }
                );
            }
        }

        // Demo Google Sign-In
        function signInWithGoogle() {
            const mockGoogleUser = {
                id: 'google_demo_' + Date.now(),
                email: 'demo@gmail.com',
                name: 'Demo Google User',
                picture: null
            };

            showNotification('ğŸ”„ Demo: Login Google berhasil!', 'success');
            loginWithGoogle(mockGoogleUser);
        }

        function loginWithGoogle(googleUserData) {
            currentUser = googleUserData.email;
            userRole = 'owner';
            isGoogleLogin = true;
            googleUser = googleUserData;
            
            // Register Google user in shared data
            registerGoogleUser(googleUserData);
            
            document.getElementById('header-user').innerHTML = `ğŸ‘¤ ${googleUserData.name}`;
            document.getElementById('sidebar-user').innerHTML = `ğŸ‘¤ ${googleUserData.name}`;
            document.getElementById('account-type-status').textContent = 'Google Account';
            document.getElementById('google-account-status').innerHTML = `<span class="text-green-600">âœ… ${googleUserData.email}</span>`;
            
            // Hide password change for Google users
            document.getElementById('change-password-section').style.display = 'none';

            showMainApp();
            showNotification(`âœ… Login berhasil dengan Google! Selamat datang ${googleUserData.name}`, 'success');
            loadUserData();
        }

        function registerGoogleUser(googleUserData) {
            const existingUser = sharedData.users.find(u => u.email === googleUserData.email);
            if (!existingUser) {
                const newUser = {
                    id: googleUserData.id,
                    username: googleUserData.email,
                    email: googleUserData.email,
                    password: null, // Google users don't have passwords
                    role: 'owner',
                    name: googleUserData.name,
                    isGoogleUser: true,
                    created: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                sharedData.users.push(newUser);
                saveSharedData();
            } else {
                existingUser.lastLogin = new Date().toISOString();
                saveSharedData();
            }
        }

        // SHARED DATA MANAGEMENT
        function saveSharedData() {
            try {
                localStorage.setItem(CLOUD_STORAGE_KEY, JSON.stringify(sharedData));
            } catch (error) {
                console.error('Failed to save shared data:', error);
            }
        }

        function loadSharedData() {
            try {
                const data = localStorage.getItem(CLOUD_STORAGE_KEY);
                if (data) {
                    sharedData = { ...sharedData, ...JSON.parse(data) };
                }
            } catch (error) {
                console.error('Failed to load shared data:', error);
            }
        }

        // USER MANAGEMENT
        function switchLoginTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form-container');
            const registerForm = document.getElementById('register-form-container');

            if (tab === 'login') {
                loginTab.className = 'flex-1 py-2 text-center border-b-2 border-primary text-primary font-medium';
                registerTab.className = 'flex-1 py-2 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.className = 'flex-1 py-2 text-center border-b-2 border-primary text-primary font-medium';
                loginTab.className = 'flex-1 py-2 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        // Manual login
        document.getElementById('manual-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = sharedData.users.find(u => 
                (u.username === username || u.email === username) && u.password === password
            );

            if (user) {
                isGoogleLogin = false;
                user.lastLogin = new Date().toISOString();
                saveSharedData();
                loginUser(user);
            } else {
                showNotification('âŒ Username/email atau password salah!', 'error');
            }
        });

        // Registration
        document.getElementById('register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            // Validation
            if (password !== confirmPassword) {
                showNotification('âŒ Password tidak cocok!', 'error');
                return;
            }

            if (sharedData.users.find(u => u.username === username)) {
                showNotification('âŒ Username sudah digunakan!', 'error');
                return;
            }

            if (sharedData.users.find(u => u.email === email)) {
                showNotification('âŒ Email sudah digunakan!', 'error');
                return;
            }

            // Create new user
            const newUser = {
                id: Date.now(),
                username,
                email,
                password,
                name,
                role: 'owner',
                created: new Date().toISOString(),
                lastLogin: null,
                isGoogleUser: false
            };

            sharedData.users.push(newUser);
            saveSharedData();

            showNotification('âœ… Akun berhasil dibuat! Silakan login.', 'success');
            switchLoginTab('login');
            
            // Auto-fill login form
            document.getElementById('username').value = username;
        });

        function loginUser(user) {
            currentUser = user.username;
            userRole = user.role;
            document.getElementById('header-user').innerHTML = user.role === 'owner' ? 'ğŸ‘‘ ' + user.name : 'ğŸ‘¤ ' + user.name;
            document.getElementById('sidebar-user').innerHTML = user.role === 'owner' ? 'ğŸ‘‘ ' + user.name : 'ğŸ‘¤ ' + user.name;
            document.getElementById('account-type-status').textContent = `Manual Account (${user.email})`;
            document.getElementById('google-account-status').innerHTML = '<span class="text-gray-500">Akun Manual</span>';
            
            showMainApp();
            if (userRole === 'kasir') {
                hideOwnerOnlyFeatures();
            }
            showNotification(`âœ… Login berhasil sebagai ${user.name}!`, 'success');
            loadUserData();
        }

        // KASIR SYSTEM WITH DP & PIUTANG
        function togglePaymentFields() {
            const paymentType = document.getElementById('kasir-payment-type').value;
            const dpFields = document.getElementById('dp-fields');
            const creditFields = document.getElementById('credit-fields');
            const amountLabel = document.getElementById('payment-amount-label');
            const amountInput = document.getElementById('kasir-payment-amount');
            const total = getCurrentCartTotal();

            // Reset and hide all special fields
            dpFields.classList.add('hidden');
            creditFields.classList.add('hidden');

            switch (paymentType) {
                case 'full':
                    amountLabel.textContent = 'Dibayar';
                    amountInput.value = total;
                    break;
                case 'dp':
                    amountLabel.textContent = 'Jumlah DP';
                    dpFields.classList.remove('hidden');
                    amountInput.value = Math.floor(total * 0.3); // Default 30% DP
                    updateRemainingPayment();
                    break;
                case 'credit':
                    amountLabel.textContent = 'Dibayar';
                    creditFields.classList.remove('hidden');
                    amountInput.value = 0;
                    break;
            }
            
            updateChangeAmount();
        }

        function updateRemainingPayment() {
            const total = getCurrentCartTotal();
            const dpAmount = parseInt(document.getElementById('kasir-payment-amount').value) || 0;
            const remaining = total - dpAmount;
            document.getElementById('remaining-payment').value = `Rp ${remaining.toLocaleString()}`;
        }

        function updateChangeAmount() {
            const total = getCurrentCartTotal();
            const paid = parseInt(document.getElementById('kasir-payment-amount').value) || 0;
            const paymentType = document.getElementById('kasir-payment-type').value;
            
            let change = 0;
            if (paymentType === 'full' && paid > total) {
                change = paid - total;
            }
            
            document.getElementById('change-amount').textContent = `Rp ${change.toLocaleString()}`;
        }

        function initializeKasir() {
            updateKasirProductOptions();
            updateCartDisplay();
            updateReceiptPreview();
            
            // Set default dates
            const today = new Date();
            const startDate = today.toISOString().split('T')[0];
            const dueDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('kasir-start-date').value = startDate;
            document.getElementById('kasir-due-date').value = dueDate;
            
            // Auto-calculate payment and remaining
            const amountInput = document.getElementById('kasir-payment-amount');
            
            if (amountInput) {
                amountInput.addEventListener('input', function() {
                    updateChangeAmount();
                    if (document.getElementById('kasir-payment-type').value === 'dp') {
                        updateRemainingPayment();
                    }
                });
            }
        }

        function addToCart() {
            const productSelect = document.getElementById('add-product');
            const quantityInput = document.getElementById('add-quantity');
            
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (!productId) {
                showNotification('âŒ Pilih produk terlebih dahulu!', 'error');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('âŒ Produk tidak ditemukan!', 'error');
                return;
            }

            if (quantity > product.stock) {
                showNotification('âŒ Stok tidak mencukupi!', 'error');
                return;
            }

            // Check if product already in cart
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity + quantity > product.stock) {
                    showNotification('âŒ Total quantity melebihi stok!', 'error');
                    return;
                }
                existingItem.quantity += quantity;
                existingItem.subtotal = existingItem.price * existingItem.quantity;
            } else {
                cart.push({
                    productId,
                    productName: product.name,
                    price: product.price,
                    cost: product.cost || 0,
                    quantity,
                    subtotal: product.price * quantity
                });
            }

            // Reset inputs
            productSelect.value = '';
            quantityInput.value = 1;
            
            updateCartDisplay();
            updateReceiptPreview();
            togglePaymentFields(); // Refresh payment fields
            showNotification('âœ… Produk ditambahkan ke keranjang!', 'success');
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartDisplay();
            updateReceiptPreview();
            togglePaymentFields();
        }

        function clearCart() {
            cart = [];
            updateCartDisplay();
            updateReceiptPreview();
            showNotification('ğŸ—‘ï¸ Keranjang dikosongkan!', 'info');
        }

        function updateCartDisplay() {
            const container = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">Keranjang kosong</p>';
                totalElement.textContent = 'Rp 0';
                return;
            }

            let total = 0;
            container.innerHTML = '';
            
            cart.forEach(item => {
                total += item.subtotal;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center text-sm bg-gray-50 dark:bg-gray-700 p-2 rounded';
                itemEl.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium">${item.productName}</span>
                        <div class="text-xs text-gray-500">${item.quantity} x Rp ${item.price.toLocaleString()}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">Rp ${item.subtotal.toLocaleString()}</div>
                        <button onclick="removeFromCart(${item.productId})" class="text-xs text-danger hover:text-red-700">Hapus</button>
                    </div>
                `;
                container.appendChild(itemEl);
            });

            totalElement.textContent = `Rp ${total.toLocaleString()}`;
        }

        function getCurrentCartTotal() {
            return cart.reduce((sum, item) => sum + item.subtotal, 0);
        }

        function updateReceiptPreview() {
            const previewElement = document.getElementById('receipt-preview');
            
            if (cart.length === 0) {
                previewElement.innerHTML = `
                    <div class="text-center">
                        <p class="font-bold text-lg">KISARA JAHIT</p>
                        <p class="text-sm">Kemiling, Bandar Lampung</p>
                        <p class="text-center my-3">================================</p>
                        <p class="text-gray-500 dark:text-gray-400">Tambahkan item ke keranjang</p>
                        <p class="text-center my-3">================================</p>
                    </div>
                `;
                return;
            }

            const customerName = document.getElementById('kasir-customer-name').value || 'Customer';
            const paymentMethod = document.getElementById('kasir-payment-method').value;
            const paymentType = document.getElementById('kasir-payment-type').value;
            const total = getCurrentCartTotal();
            const paid = parseInt(document.getElementById('kasir-payment-amount').value) || 0;
            const change = Math.max(0, paid - total);

            let receipt = '';
            receipt += '================================\n';
            receipt += `        KISARA JAHIT\n`;
            receipt += '================================\n';
            receipt += `Customer: ${customerName}\n`;
            receipt += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n`;
            receipt += `Waktu: ${new Date().toLocaleTimeString('id-ID')}\n`;
            receipt += '================================\n';
            
            cart.forEach(item => {
                receipt += `${item.productName}\n`;
                receipt += `${item.quantity} x Rp ${item.price.toLocaleString()}\n`;
                receipt += `                Rp ${item.subtotal.toLocaleString()}\n`;
                receipt += '--------------------------------\n';
            });
            
            receipt += `TOTAL           Rp ${total.toLocaleString()}\n`;
            
            if (paid > 0) {
                receipt += '================================\n';
                receipt += `Metode: ${paymentMethod}\n`;
                
                if (paymentType === 'dp') {
                    receipt += `DP: Rp ${paid.toLocaleString()}\n`;
                    receipt += `Sisa: Rp ${(total - paid).toLocaleString()}\n`;
                } else if (paymentType === 'credit') {
                    receipt += `Piutang: Rp ${total.toLocaleString()}\n`;
                } else {
                    receipt += `Dibayar: Rp ${paid.toLocaleString()}\n`;
                    if (change > 0) {
                        receipt += `Kembalian: Rp ${change.toLocaleString()}\n`;
                    }
                }
                receipt += '================================\n';
                receipt += '       TERIMA KASIH!\n';
            }
            receipt += '================================\n';

            previewElement.innerHTML = `<pre class="whitespace-pre-wrap text-xs text-left">${receipt}</pre>`;
        }

        // Kasir form submission with DP & Piutang support
        document.getElementById('kasir-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (cart.length === 0) {
                showNotification('âŒ Keranjang kosong!', 'error');
                return;
            }

            const customerName = document.getElementById('kasir-customer-name').value;
            const customerPhone = document.getElementById('kasir-customer-phone').value;
            const paymentMethod = document.getElementById('kasir-payment-method').value;
            const paymentType = document.getElementById('kasir-payment-type').value;
            const paymentAmount = parseInt(document.getElementById('kasir-payment-amount').value) || 0;
            const notes = document.getElementById('kasir-notes').value;
            const specialNotes = document.getElementById('kasir-special-notes').value;
            const startDate = document.getElementById('kasir-start-date').value;
            const dueDate = document.getElementById('kasir-due-date').value;

            if (!customerName) {
                showNotification('âŒ Nama pelanggan wajib diisi!', 'error');
                return;
            }

            const total = getCurrentCartTotal();
            
            // Validation based on payment type
            if (paymentType === 'full' && paymentAmount < total) {
                showNotification('âŒ Jumlah pembayaran kurang!', 'error');
                return;
            }

            if (paymentType === 'dp' && paymentAmount >= total) {
                showNotification('âŒ DP tidak boleh sama atau lebih dari total!', 'error');
                return;
            }

            // Process the transaction
            const orderId = Date.now();
            const totalProfit = cart.reduce((sum, item) => sum + ((item.price - item.cost) * item.quantity), 0);

            // Determine order status
            let orderStatus = 'pending';
            let paymentStatus = 'pending';
            
            if (paymentType === 'full') {
                orderStatus = 'completed';
                paymentStatus = 'paid';
            } else if (paymentType === 'dp') {
                orderStatus = 'in_progress';
                paymentStatus = 'dp_paid';
            } else if (paymentType === 'credit') {
                orderStatus = 'pending';
                paymentStatus = 'credit';
            }

            // Create order record
            const order = {
                id: orderId,
                customerName,
                customerPhone: customerPhone || '',
                items: [...cart],
                total,
                profit: totalProfit,
                status: orderStatus,
                paymentStatus,
                paymentMethod,
                paymentAmount,
                remainingAmount: total - paymentAmount,
                change: paymentType === 'full' ? Math.max(0, paymentAmount - total) : 0,
                notes,
                specialNotes,
                startDate,
                dueDate,
                paymentType,
                date: new Date().toISOString(),
                createdBy: currentUser
            };

            // Handle DP and Credit entries
            if (paymentType === 'dp' || paymentType === 'credit') {
                const piutangEntry = {
                    id: Date.now() + 1,
                    orderId,
                    customerName,
                    customerPhone,
                    totalAmount: total,
                    paidAmount: paymentAmount,
                    remainingAmount: total - paymentAmount,
                    type: paymentType,
                    status: 'active',
                    dueDate: paymentType === 'dp' ? document.getElementById('dp-due-date').value : document.getElementById('credit-due-date').value,
                    createdDate: new Date().toISOString(),
                    payments: paymentAmount > 0 ? [{
                        amount: paymentAmount,
                        date: new Date().toISOString(),
                        method: paymentMethod,
                        notes: notes
                    }] : []
                };
                
                if (!piutangData) piutangData = [];
                piutangData.push(piutangEntry);
            }

            // Update product stocks
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.stock -= item.quantity;
                }
            });

            // Save data
            if (!orders) orders = [];
            orders.unshift(order);
            
            if (customerPhone) {
                updateCustomerDatabase(customerName, customerPhone, total);
            }

            // Auto print if printer connected
            try {
                if (settings && settings.printerConnected) {
                    const receiptText = generateReceiptText(order);
                    printToThermalPrinter(receiptText);
                    showNotification('âœ… Transaksi berhasil & struk dicetak!', 'success');
                } else {
                    showNotification('âœ… Transaksi berhasil!', 'success');
                }
            } catch (error) {
                showNotification('âœ… Transaksi berhasil, gagal cetak struk!', 'warning');
            }

            // Reset form
            this.reset();
            clearCart();
            
            // Reset dates to default
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            document.getElementById('kasir-start-date').value = today.toISOString().split('T')[0];
            document.getElementById('kasir-due-date').value = nextWeek.toISOString().split('T')[0];
            
            addRecentActivity(`ğŸ’° Transaksi ${paymentType === 'dp' ? 'DP' : paymentType === 'credit' ? 'Piutang' : 'Lunas'}: ${customerName} - Rp ${total.toLocaleString()}`);
            
            // Update stats and save
            updateStats();
            updatePiutangStats();
            autoSave();
        });

        // PIUTANG MANAGEMENT
        function filterPiutang() {
            const filter = document.getElementById('piutang-filter').value;
            renderPiutangList(filter);
        }

        function renderPiutangList(filter = 'all') {
            const container = document.getElementById('piutang-list');
            if (!container) return;

            container.innerHTML = '';

            if (!piutangData || piutangData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Belum ada piutang atau DP</p>';
                return;
            }

            // Filter data
            let filteredData = piutangData.filter(item => item.status === 'active');
            
            if (filter === 'dp') {
                filteredData = filteredData.filter(item => item.type === 'dp');
            } else if (filter === 'credit') {
                filteredData = filteredData.filter(item => item.type === 'credit');
            } else if (filter === 'overdue') {
                const today = new Date();
                filteredData = filteredData.filter(item => {
                    const dueDate = new Date(item.dueDate);
                    return dueDate < today;
                });
            }

            // Sort by creation date
            filteredData.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));

            filteredData.forEach(item => {
                const isOverdue = new Date(item.dueDate) < new Date();
                const daysUntilDue = Math.ceil((new Date(item.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                const itemEl = document.createElement('div');
                itemEl.className = `border border-gray-200 dark:border-gray-700 rounded-lg p-4 ${isOverdue ? 'bg-red-50 dark:bg-red-900/20' : 'bg-white dark:bg-gray-800'}`;
                itemEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">${item.customerName}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${item.customerPhone || 'No phone'}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-2 py-1 rounded text-xs font-medium ${
                                item.type === 'dp' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'
                            }">
                                ${item.type === 'dp' ? 'ğŸ’³ DP' : 'ğŸ“ Piutang'}
                            </span>
                            ${isOverdue ? '<div class="text-xs text-red-600 mt-1">â° Jatuh Tempo</div>' : ''}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Total:</span>
                            <span class="font-medium">Rp ${item.totalAmount.toLocaleString()}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Dibayar:</span>
                            <span class="font-medium text-green-600">Rp ${item.paidAmount.toLocaleString()}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Sisa:</span>
                            <span class="font-medium text-red-600">Rp ${item.remainingAmount.toLocaleString()}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Jatuh Tempo:</span>
                            <span class="font-medium ${isOverdue ? 'text-red-600' : ''}">${new Date(item.dueDate).toLocaleDateString('id-ID')}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="showPaymentModal(${item.id})" class="flex-1 bg-primary text-white py-2 px-3 rounded text-sm hover:bg-primary-dark">
                            ğŸ’° Bayar
                        </button>
                        <button onclick="viewPiutangDetails(${item.id})" class="bg-secondary text-white py-2 px-3 rounded text-sm hover:bg-blue-600">
                            ğŸ‘ï¸ Detail
                        </button>
                        <button onclick="sendReminderMessage(${item.id})" class="bg-whatsapp text-white py-2 px-3 rounded text-sm hover:bg-green-600">
                            ğŸ’¬ Ingatkan
                        </button>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function updatePiutangStats() {
            const totalPiutang = piutangData
                .filter(item => item.status === 'active')
                .reduce((sum, item) => sum + item.remainingAmount, 0);
            
            const overdueCount = piutangData
                .filter(item => item.status === 'active' && new Date(item.dueDate) < new Date())
                .length;
            
            const dpPendingCount = piutangData
                .filter(item => item.status === 'active' && item.type === 'dp')
                .length;

            if (document.getElementById('total-piutang')) {
                document.getElementById('total-piutang').textContent = `Rp ${totalPiutang.toLocaleString()}`;
            }
            if (document.getElementById('piutang-summary-total')) {
                document.getElementById('piutang-summary-total').textContent = `Rp ${totalPiutang.toLocaleString()}`;
            }
            if (document.getElementById('overdue-count')) {
                document.getElementById('overdue-count').textContent = overdueCount;
            }
            if (document.getElementById('dp-pending-count')) {
                document.getElementById('dp-pending-count').textContent = dpPendingCount;
            }
        }

        function showPaymentModal(piutangId) {
            const piutang = piutangData.find(p => p.id === piutangId);
            if (!piutang) return;

            showConfirmDialog(`
                ğŸ’° Pembayaran ${piutang.type === 'dp' ? 'DP' : 'Piutang'}<br><br>
                Customer: ${piutang.customerName}<br>
                Sisa: Rp ${piutang.remainingAmount.toLocaleString()}<br><br>
                <input type="number" id="payment-amount-modal" placeholder="Jumlah pembayaran" class="w-full px-3 py-2 border rounded mb-3" value="${piutang.remainingAmount}">
                <select id="payment-method-modal" class="w-full px-3 py-2 border rounded mb-3">
                    <option value="Tunai">ğŸ’µ Tunai</option>
                    <option value="Transfer Bank">ğŸ¦ Transfer Bank</option>
                    <option value="E-Wallet">ğŸ’³ E-Wallet</option>
                    <option value="QRIS">ğŸ“± QRIS</option>
                </select>
                <textarea id="payment-notes-modal" placeholder="Catatan..." class="w-full px-3 py-2 border rounded" rows="2"></textarea>
            `, () => processPayment(piutangId));
        }

        function processPayment(piutangId) {
            const piutang = piutangData.find(p => p.id === piutangId);
            if (!piutang) return;

            const amount = parseInt(document.getElementById('payment-amount-modal').value) || 0;
            const method = document.getElementById('payment-method-modal').value;
            const notes = document.getElementById('payment-notes-modal').value;

            if (amount <= 0) {
                showNotification('âŒ Jumlah pembayaran tidak valid!', 'error');
                return;
            }

            if (amount > piutang.remainingAmount) {
                showNotification('âŒ Jumlah pembayaran melebihi sisa!', 'error');
                return;
            }

            // Record payment
            const payment = {
                amount,
                date: new Date().toISOString(),
                method,
                notes
            };

            piutang.payments.push(payment);
            piutang.paidAmount += amount;
            piutang.remainingAmount -= amount;

            // Check if fully paid
            if (piutang.remainingAmount <= 0) {
                piutang.status = 'paid';
                piutang.completedDate = new Date().toISOString();
            }

            // Update order status if applicable
            const order = orders.find(o => o.id === piutang.orderId);
            if (order && piutang.remainingAmount <= 0) {
                if (piutang.type === 'dp') {
                    order.paymentStatus = 'completed';
                    order.status = 'completed';
                } else if (piutang.type === 'credit') {
                    order.paymentStatus = 'paid';
                    order.status = 'completed';
                }
            }

            addRecentActivity(`ğŸ’° Pembayaran ${piutang.type === 'dp' ? 'DP' : 'Piutang'}: ${piutang.customerName} - Rp ${amount.toLocaleString()}`);
            
            updatePiutangStats();
            renderPiutangList();
            autoSave();
            
            showNotification('âœ… Pembayaran berhasil dicatat!', 'success');
        }

        // UTILITY FUNCTIONS
        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="text-gray-700 dark:text-gray-300 mb-4">${message}</div>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Batal</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded" onclick="this.closest('.fixed').remove(); (${onConfirm})()">Konfirmasi</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Enhanced sidebar navigation
        function openSidebar() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('mobile-menu-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('mobile-menu-overlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        document.getElementById('mobile-menu-overlay').addEventListener('click', closeSidebar);

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById(sectionName + '-section').classList.remove('hidden');

            const titles = {
                dashboard: 'Dashboard',
                katalog: 'Katalog Produk',
                kasir: 'Kasir & Pembayaran',
                pesanan: 'Kelola Pesanan',
                piutang: 'Piutang & DP',
                pelanggan: 'Database Pelanggan',
                pesan: 'Template Pesan',
                laporan: 'Laporan & Analisis',
                pengaturan: 'Pengaturan'
            };
            
            document.getElementById('section-title').textContent = titles[sectionName] || sectionName;

            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('bg-primary', 'text-white');
            });

            closeSidebar();

            if (sectionName === 'kasir') {
                initializeKasir();
            }

            if (sectionName === 'piutang') {
                updatePiutangStats();
                renderPiutangList();
            }

            if (sectionName === 'pengaturan') {
                loadStoreSettings();
            }
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            showSection('dashboard');
            initializeKasir();
        }

        function logout() {
            if (isGoogleLogin && googleUser) {
                googleUser = null;
            }
            
            currentUser = null;
            userRole = null;
            isGoogleLogin = false;
            
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Reset forms
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('change-password-form').reset();
            
            // Reset account status
            document.getElementById('account-type-status').textContent = 'Manual Account';
            document.getElementById('google-account-status').innerHTML = '<span class="text-gray-500">Akun Manual</span>';
            document.getElementById('change-password-section').style.display = 'block';

            // Show all elements again
            const ownerOnlyElements = document.querySelectorAll('.owner-only');
            ownerOnlyElements.forEach(element => {
                element.classList.remove('hidden');
            });

            showNotification('ğŸšª Berhasil logout!', 'info');
        }

        // Utility functions
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
        }

        function hideOwnerOnlyFeatures() {
            const ownerOnlyElements = document.querySelectorAll('.owner-only');
            ownerOnlyElements.forEach(element => {
                element.classList.add('hidden');
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-white shadow-lg animate-fade-in max-w-sm ${
                type === 'success' ? 'bg-success' : 
                type === 'error' ? 'bg-danger' : 
                type === 'warning' ? 'bg-warning' :
                'bg-primary'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Data management
        function saveToLocalStorage() {
            try {
                const storageKey = isGoogleLogin && googleUser ? 
                    `tokoData_${googleUser.id}` : `tokoData_${currentUser}`;
                
                const data = {
                    products,
                    orders,
                    customers,
                    messageTemplates,
                    payments,
                    piutangData,
                    settings,
                    recentActivities,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem(storageKey, JSON.stringify(data));
                saveSharedData(); // Also save shared data
                
                document.getElementById('save-status').textContent = 'ğŸ’¾ TERSIMPAN';
                document.getElementById('save-status').className = 'text-xs text-green-200';

                setTimeout(() => {
                    document.getElementById('save-status').textContent = 'ğŸ’¾ AUTO SAVE';
                    document.getElementById('save-status').className = 'text-xs text-blue-200';
                }, 2000);

            } catch (error) {
                console.error('âŒ Gagal menyimpan:', error);
                showNotification('âŒ Gagal menyimpan data!', 'error');
            }
        }

        function loadUserData() {
            try {
                const storageKey = isGoogleLogin && googleUser ? 
                    `tokoData_${googleUser.id}` : `tokoData_${currentUser}`;
                
                const savedData = localStorage.getItem(storageKey);
                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.products) products = data.products;
                    if (data.orders) orders = data.orders;
                    if (data.customers) customers = data.customers;
                    if (data.messageTemplates) messageTemplates = data.messageTemplates;
                    if (data.payments) payments = data.payments;
                    if (data.piutangData) piutangData = data.piutangData;
                    if (data.settings) settings = { ...settings, ...data.settings };
                    if (data.recentActivities) recentActivities = data.recentActivities;

                    initializeApp();
                    return true;
                }
            } catch (error) {
                console.error('âŒ Gagal memuat data:', error);
            }
            
            initSampleData();
            return false;
        }

        function autoSave() {
            saveToLocalStorage();
        }

        // Basic functions that were referenced
        function updateKasirProductOptions() {
            const select = document.getElementById('add-product');
            if (!select) return;

            select.innerHTML = '<option value="">Pilih produk...</option>';

            if (products) {
                products.filter(p => p.stock > 0).forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - Rp ${product.price.toLocaleString()} (Stok: ${product.stock})`;
                    select.appendChild(option);
                });
            }
        }

        function updateCustomerDatabase(name, phone, orderValue) {
            if (!customers) customers = [];
            
            let customer = customers.find(c => c.phone === phone);

            if (!customer) {
                customer = {
                    id: Date.now(),
                    name,
                    phone,
                    totalOrders: 0,
                    totalSpent: 0,
                    lastOrder: new Date().toISOString()
                };
                customers.push(customer);
            }

            customer.totalOrders++;
            customer.totalSpent += orderValue;
            customer.lastOrder = new Date().toISOString();
            customer.name = name;
        }

        function updateStats() {
            if (document.getElementById('total-products')) {
                document.getElementById('total-products').textContent = products.length;
            }
            if (document.getElementById('total-orders')) {
                document.getElementById('total-orders').textContent = orders.length;
            }

            // Calculate profits
            const completedOrders = orders.filter(o => o.status === 'completed' || o.status === 'paid');
            const today = new Date().toDateString();
            const todayProfit = completedOrders
                .filter(o => new Date(o.date).toDateString() === today)
                .reduce((sum, order) => sum + (order.profit || 0), 0);
            
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthlyProfit = completedOrders
                .filter(o => o.date.slice(0, 7) === thisMonth)
                .reduce((sum, order) => sum + (order.profit || 0), 0);

            if (document.getElementById('today-profit')) {
                document.getElementById('today-profit').textContent = `Rp ${todayProfit.toLocaleString()}`;
            }
            if (document.getElementById('monthly-profit')) {
                document.getElementById('monthly-profit').textContent = `Rp ${monthlyProfit.toLocaleString()}`;
            }
        }

        function addRecentActivity(activity) {
            if (!recentActivities) recentActivities = [];
            
            const now = new Date();
            recentActivities.unshift({
                text: activity,
                time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                date: now.toLocaleDateString('id-ID')
            });

            recentActivities = recentActivities.slice(0, 10);
            renderRecentActivity();
        }

        function renderRecentActivity() {
            const container = document.getElementById('recent-activity');
            if (!container) return;

            container.innerHTML = '';

            if (!recentActivities || recentActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada aktivitas</p>';
                return;
            }

            recentActivities.forEach(activity => {
                const activityEl = document.createElement('div');
                activityEl.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                activityEl.innerHTML = `
                    <span class="text-sm text-gray-800 dark:text-white">${activity.text}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400">${activity.time}</span>
                `;
                container.appendChild(activityEl);
            });
        }

        function loadStoreSettings() {
            if (document.getElementById('store-name-input')) {
                document.getElementById('store-name-input').value = settings.storeName || '';
            }
            if (document.getElementById('admin-phone-input')) {
                document.getElementById('admin-phone-input').value = settings.adminPhone || '';
            }
            if (document.getElementById('bank-info-input')) {
                document.getElementById('bank-info-input').value = settings.bankInfo || '';
            }
            if (document.getElementById('store-address-input')) {
                document.getElementById('store-address-input').value = settings.storeAddress || '';
            }
        }

        // Store settings form
        if (document.getElementById('store-settings-form')) {
            document.getElementById('store-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();

                settings.storeName = document.getElementById('store-name-input').value;
                settings.adminPhone = document.getElementById('admin-phone-input').value;
                settings.bankInfo = document.getElementById('bank-info-input').value;
                settings.storeAddress = document.getElementById('store-address-input').value;

                autoSave();
                showNotification('âœ… Pengaturan toko berhasil disimpan!', 'success');
            });
        }

        // Change password
        document.getElementById('change-password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (isGoogleLogin) {
                showNotification('âŒ Akun Google tidak dapat mengubah password!', 'error');
                return;
            }

            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;

            const user = sharedData.users.find(u => u.username === currentUser || u.email === currentUser);
            
            if (!user || user.password !== oldPassword) {
                showNotification('âŒ Password lama salah!', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('âŒ Password baru tidak cocok!', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showNotification('âŒ Password minimal 6 karakter!', 'error');
                return;
            }

            user.password = newPassword;
            saveSharedData();
            
            this.reset();
            showNotification('âœ… Password berhasil diubah!', 'success');
        });

        function initSampleData() {
            products = [
                {
                    id: 1,
                    name: "Kaos Polos Premium",
                    price: 75000,
                    cost: 45000,
                    stock: 50,
                    category: "Fashion",
                    description: "Kaos polos berbahan cotton combed 30s",
                    created: new Date().toISOString()
                }
            ];

            piutangData = [];
            initializeApp();
            autoSave();
        }

        function initializeApp() {
            updateStats();
            updatePiutangStats();
            renderRecentActivity();
            updateKasirProductOptions();
            addRecentActivity('ğŸš€ Aplikasi siap digunakan');
        }

        // Placeholder functions for printer and other features
        function connectPrinter() {
            showNotification('ğŸ–¨ï¸ Fitur printer akan segera hadir!', 'info');
        }

        function testPrint() {
            showNotification('ğŸ§ª Test print berhasil!', 'success');
        }

        function disconnectPrinter() {
            showNotification('ğŸ”Œ Printer diputus!', 'info');
        }

        function generateReceiptText(order) {
            return `Struk transaksi untuk ${order.customerName}`;
        }

        function printToThermalPrinter(text) {
            console.log('Printing:', text);
        }

        function quickSummary() {
            showNotification('ğŸ“Š Ringkasan cepat dicopy ke clipboard!', 'success');
        }

        function shareToko() {
            const message = `ğŸ›ï¸ *${settings.storeName}*\n\nKunjungi toko online kami!`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function exportAllData() {
            showNotification('ğŸ“Š Data berhasil diexport!', 'success');
        }

        function clearAllData() {
            if (userRole !== 'owner') {
                showNotification('âŒ Hanya Owner yang dapat menghapus data!', 'error');
                return;
            }

            products = [];
            orders = [];
            customers = [];
            messageTemplates = [];
            payments = [];
            piutangData = [];
            recentActivities = [];
            
            initializeApp();
            autoSave();
            showNotification('ğŸ—‘ï¸ Semua data berhasil dihapus!', 'success');
        }

        function viewPiutangDetails(piutangId) {
            showNotification('ğŸ‘ï¸ Fitur detail piutang akan segera hadir!', 'info');
        }

        function sendReminderMessage(piutangId) {
            const piutang = piutangData.find(p => p.id === piutangId);
            if (!piutang || !piutang.customerPhone) {
                showNotification('âŒ No. WhatsApp tidak tersedia!', 'error');
                return;
            }

            const message = `Halo ${piutang.customerName}!\n\nRemindernya bahwa Anda memiliki ${piutang.type === 'dp' ? 'sisa pembayaran DP' : 'piutang'} sebesar Rp ${piutang.remainingAmount.toLocaleString()}\n\nJatuh tempo: ${new Date(piutang.dueDate).toLocaleDateString('id-ID')}\n\nTerima kasih!\n\n${settings.storeName}`;
            
            const whatsappUrl = `https://wa.me/${piutang.customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('ğŸ’¬ Pesan reminder dibuka di WhatsApp!', 'success');
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadSharedData();
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Initialize Google API after a short delay
            setTimeout(() => {
                initializeGoogleAPI();
            }, 1000);
        });
    </script>
</body>
</html>
